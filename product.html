<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Product Details - B-One Interior Premium Collection</title>
    <meta property="og:title" content="Product Details - B-One Interior Premium Collection">
    <meta property="og:description"
        content="View detailed product specifications, pricing, and high-quality images. Add to your cart and bring home elegance with B-One Interior's premium furniture selection.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://b-oneinterior.com/logo.png">
    <meta name="twitter:image" content="https://b-oneinterior.com/logo.png">

    <!-- Tailwind CSS -->
    <script src="assets/js/tailwind.min.js"></script>

    <!-- jQuery + Owl Carousel -->
    <script src="assets/js/jquery.min.js"></script>
    <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
    <link rel="stylesheet" href="assets/css/owl.theme.default.min.css">
    <script src="assets/js/owl.carousel.min.js"></script>
    <script type="module" src="assets/js/ionicons/ionicons.esm.js"></script>

    <link rel="stylesheet" href="style.css">

</head>

<body class="bg-black min-h-screen flex flex-col text-gray-100">

    <!-- Header -->
    <header class="bg-black shadow-lg sticky sticky top-0 z-50 border-b border-gold-700 pt-1">
        <nav class="container mx-auto px-4 py-4 flex items-center justify-between" id="desktop-nav">
            <div class="text-2xl font-bold text-gold-500"><img src="logo.png" style="height: 8vh;" alt=""></div>

            <ul class="hidden md:flex space-x-6 text-gray-300">
                <li><a href="https://b-oneinterior.com/" class="hover:text-gold-500 transition">Home</a></li>
                <li><a href="https://b-oneinterior.com/shop" class="hover:text-gold-500 transition">Shop</a></li>
                <li><a href="https://b-oneinterior.com/company" class="hover:text-gold-500 transition">Services</a></li>
                <li><a href="https://b-oneinterior.com/gallery" class="hover:text-gold-500 transition">Gallery</a></li>
                <li><a href="https://b-oneinterior.com/cart" class="hover:text-gold-500 transition">Cart</a></li>
            </ul>
            <button class="md:hidden text-gold-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
        </nav>



        <div id="drawer">
            <ul>
                <li><a href="https://b-oneinterior.com/company">Company</a></li>
                <li><a href="https://b-oneinterior.com/shop">Shop</a></li>
                <li><a href="https://b-oneinterior.com/company">Services</a></li>
                <li><a href="https://b-oneinterior.com/gallery">Gallery</a></li>
                <li><a href="https://b-oneinterior.com/#contact">Contact Us</a></li>
                <li><a href="terms.html">Terms and Conditions</a></li>
                <li><a href="privacy.html">Privacy Policy</a></li>
            </ul>
        </div>
        <label for="menu-toggle" class="overlay"></label>

        <div class="fixedBottom">
            <a href="https://b-oneinterior.com/" class="logoBx"></a>
            <ul>
                <li>
                    <a href="https://b-oneinterior.com/gallery">
                        <ion-icon name="images-outline"></ion-icon>
                        <div>Gallery</div>
                    </a>
                </li>


                <li>
                    <a href="https://b-oneinterior.com/shop">
                        <ion-icon name="storefront-outline" class="text-[#D4AF37] text-2xl"></ion-icon>
                        <div>Shop</div>

                    </a>
                </li>
                <li></li>

                <li>
                    <div class="cursor-pointer" onclick="toggleDrawer()">
                        <ion-icon name="menu-outline" class="text-[#D4AF37] text-2xl"></ion-icon>
                        <div>Menu</div>
                    </div>
                </li>


                <li>
                    <a href="https://b-oneinterior.com/cart">
                        <ion-icon name="cart-outline"></ion-icon>
                        <div>Cart</div>
                        <span id="cartCountBadge" class="absolute -top-2 -right-3 bg-gold text-black text-xs font-bold 
                                w-5 h-5 flex items-center justify-center rounded-full hidden">
                        </span>

                    </a>
                </li>
            </ul>
        </div>

    </header>

    <script>
        function toggleDrawer() {
            const drawer = document.getElementById("drawer");
            const overlay = document.querySelector(".overlay");
            if (drawer.style.left === "0px") {
                drawer.style.left = "-250px";
                overlay.style.opacity = "0";
                overlay.style.pointerEvents = "none";
            } else {
                drawer.style.left = "0px";
                overlay.style.opacity = "1";
                overlay.style.pointerEvents = "auto";
            }
        }

        const overlay = document.querySelector(".overlay");
        overlay.addEventListener("click", () => {
            const drawer = document.getElementById("drawer");
            drawer.style.left = "-250px";
            overlay.style.opacity = "0";
            overlay.style.pointerEvents = "none";
        });
    </script>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gold"></div>
        </div>

        <div id="productDetail" class="hidden grid grid-cols-1 md:grid-cols-2 gap-12">

            <!-- Left: Image Section -->
            <div class="w-full">
                <div id="imageContainer"
                    class="rounded-lg overflow-hidden shadow-lg bg-gray-900 border border-gray-800">
                    <!-- Carousel will be injected here -->
                </div>
                <div id="variantContainer" class="mt-4 grid grid-cols-3 sm:grid-cols-4 gap-4">
                    <!-- Variants will be injected here -->
                </div>
            </div>

            <!-- Right: Details Section -->
            <div class="flex flex-col space-y-6">

                <!-- Title & Price -->
                <div>
                    <div id="metaContainer" class="flex flex-wrap gap-2 mb-3"></div>
                    <h1 id="productName" class="text-3xl md:text-4xl font-bold text-white mb-2"></h1>
                    <div id="priceContainer" class="flex items-baseline gap-4 mt-2"></div>
                </div>

                <!-- Catalogue Button -->
                <div id="catalogueContainer"></div>

                <!-- Short Description / Attributes -->
                <div id="descriptionContainer" class="text-gray-300 leading-relaxed text-sm md:text-base"></div>

                <!-- Attributes List -->
                <div id="attributesContainer" class="space-y-2 pt-4 border-t"></div>

                <!-- Add to Cart / Quantity -->
                <div class="pt-6 mt-auto">
                    <div id="cartActionContainer" class="w-full"></div>
                </div>

            </div>
        </div>

        <!-- Recommended Products Section -->
        <div id="recommendedSection" class="hidden mt-12 border-t border-gray-800 pt-8">
            <h2 class="text-2xl font-bold mb-6 text-white">Recommended For You</h2>
            <div id="recommendedCarousel" class="owl-carousel owl-theme"></div>
        </div>

        <!-- Collection Products Section -->
        <div id="collectionSection" class="hidden mt-12 border-t border-gray-800 pt-8">
            <h2 id="collectionTitle" class="text-2xl font-bold mb-6 text-white">More from this Collection</h2>
            <div id="collectionCarousel" class="owl-carousel owl-theme"></div>
        </div>

        <div id="errorContainer" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold text-gray-400">Product not found</h2>
            <a href="shop.html" class="text-gold hover:underline mt-4 inline-block">Return to Shop</a>
        </div>

    </main>


    <!-- Catalogue Viewer Modal -->
    <div id="catalogueModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm">

        <!-- Close Button -->
        <button onclick="closeCatalogue()"
            class="absolute top-6 right-6 bg-red-600 text-white rounded-full p-2 z-[200] shadow-lg hover:bg-red-700 transition transform hover:scale-110 flex items-center justify-center">
            <ion-icon name="close-outline" class="text-3xl"></ion-icon>
        </button>

        <!-- Floating Prev Button (Outside) -->
        <button onclick="changePage(-1)" id="catPrevBtn"
            class="absolute left-4 top-1/2 -translate-y-1/2 bg-gray-800/80 text-white hover:bg-gold hover:text-white rounded-full p-4 z-[200] transition transform hover:scale-110 disabled:opacity-0 disabled:pointer-events-none">
            <ion-icon name="chevron-back-outline" class="text-4xl"></ion-icon>
        </button>

        <!-- Floating Next Button (Outside) -->
        <button onclick="changePage(1)" id="catNextBtn"
            class="absolute right-4 top-1/2 -translate-y-1/2 bg-gray-800/80 text-white hover:bg-gold hover:text-white rounded-full p-4 z-[200] transition transform hover:scale-110 disabled:opacity-0 disabled:pointer-events-none">
            <ion-icon name="chevron-forward-outline" class="text-4xl"></ion-icon>
        </button>

        <!-- Zoom Controls -->
        <div class="absolute top-24 right-6 flex flex-col gap-2 z-[200]">
            <button onclick="shareCatalogue()" title="Share Catalogue"
                class="bg-gray-800/90 text-white hover:text-gold p-3 rounded-full shadow-lg transition hover:scale-110">
                <ion-icon name="share-outline" class="text-xl"></ion-icon>
            </button>
            <button onclick="updateZoom(0.25)"
                class="bg-gray-800/90 text-white hover:text-gold p-3 rounded-full shadow-lg transition hover:scale-110">
                <ion-icon name="add-outline" class="text-xl"></ion-icon>
            </button>
            <button onclick="updateZoom(-0.25)"
                class="bg-gray-800/90 text-white hover:text-gold p-3 rounded-full shadow-lg transition hover:scale-110">
                <ion-icon name="remove-outline" class="text-xl"></ion-icon>
            </button>
            <button onclick="resetZoom()"
                class="bg-gray-800/90 text-white hover:text-gold p-3 rounded-full shadow-lg transition hover:scale-110"
                title="Reset Zoom">
                <ion-icon name="scan-outline" class="text-xl"></ion-icon>
            </button>
        </div>

        <div class="relative w-full h-full flex flex-col items-center justify-center p-4 content-center">
            <div id="catalogueViewer"
                class="relative max-w-6xl w-full h-[90vh] flex items-center justify-center bg-gray-900 rounded-lg overflow-hidden border border-gray-800 shadow-2xl cursor-grab active:cursor-grabbing">
                <!-- Canvas injected here -->
                <div id="catalogueLoader"
                    class="absolute inset-0 flex items-center justify-center bg-black/50 z-10 hidden rounded-lg">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gold"></div>
                </div>
            </div>
            <!-- Footer Removed as requested -->
        </div>
    </div>


    <script>
        const API_URL = "https://api.b-oneinterior.com/graphql/";
        const FALLBACK_IMG = "images/placeholder.png";

        // Get Product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        function renderGallery(media, fallbackUrl, altName) {
            // Show Loader
            const spinner = document.getElementById("loadingSpinner");
            spinner.classList.remove("hidden");

            const container = document.getElementById("imageContainer");
            const $carousel = $('.product-image-carousel');
            if ($carousel.length > 0) {
                $carousel.trigger('destroy.owl.carousel');
            }

            let imageHtml = "";
            let hasImages = false;

            if (media && media.length > 0) {
                // Check if there are actual images
                const images = media.filter(m => !m.type || m.type === 'IMAGE');
                if (images.length > 0) {
                    hasImages = true;
                    imageHtml = `<div class="owl-carousel product-image-carousel h-96 md:h-[500px]">`;
                    images.forEach(m => {
                        imageHtml += `<div class="item h-full"><img src="${m.url}" class="w-full h-full object-cover object-center" alt="${altName}"></div>`;
                    });
                    imageHtml += `</div>`;
                }
            }

            if (!hasImages) {
                imageHtml = `<img src="${fallbackUrl || FALLBACK_IMG}" class="w-full h-96 md:h-[500px] object-cover object-center" alt="${altName}">`;
            }

            container.innerHTML = imageHtml;

            if (hasImages) {
                setTimeout(() => {
                    $('.product-image-carousel').owlCarousel({
                        items: 1,
                        loop: true,
                        dots: true,
                        nav: false,
                        autoplay: true,
                        autoplayHoverPause: true
                    });
                    // Hide Loader after init
                    setTimeout(() => spinner.classList.add("hidden"), 300);
                }, 100);
            } else {
                // Hide loader immediately if no carousel
                setTimeout(() => spinner.classList.add("hidden"), 300);
            }
        }

        async function fetchProductDetails(id) {
            const query = `
            query {
                product(id: "${id}", channel: "in") {
                    id
                    name
                    description
                    media {
                        url
                        type
                    }
                    thumbnail {
                        url
                    }
                    metadata {
                        key
                        value
                    }
                    pricing {
                        priceRange {
                            start {
                                gross {
                                    amount
                                    currency
                                }
                            }
                        }
                    }
                    attributes {
                        attribute {
                            name
                        }
                        values {
                            name
                            file {
                                url
                            }
                        }
                    }
                    category {
                        name
                    }
                    productType {
                        name
                    }
                    variants {
                        id
                        name
                        media {
                            url
                            type
                        }
                        pricing {
                            price {
                                gross {
                                    amount
                                    currency
                                }
                            }
                        }
                    }
                    collections {
                        id
                        name
                    }
                }
            }
            `;

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query })
                });
                const json = await res.json();
                return json.data?.product;
            } catch (err) {
                console.error(err);
                return null;
            }

        }

        async function fetchRecommendedProducts(categoryName, currentId) {
            const query = `
            query {
                products(first: 100, channel: "in") {
                    edges {
                        node {
                            id
                            name
                            thumbnail { url }
                            pricing {
                                priceRange {
                                    start {
                                        gross {
                                            amount
                                            currency
                                        }
                                    }
                                }
                            }
                            category { name }
                        }
                    }
                }
            }
            `;

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query })
                });
                const json = await res.json();
                let products = json.data?.products?.edges || [];

                // Filter by Category & Exclude Current
                products = products.filter(p =>
                    p.node.category?.name === categoryName &&
                    p.node.id !== currentId
                ).slice(0, 10);

                const carousel = document.getElementById("recommendedCarousel");
                const section = document.getElementById("recommendedSection");
                carousel.innerHTML = "";

                if (products.length === 0) {
                    section.classList.add("hidden");
                    return;
                }

                section.classList.remove("hidden");

                products.forEach(p => {
                    const price = p.node.pricing?.priceRange?.start?.gross?.amount?.toFixed(2) || "0.00";
                    const currency = p.node.pricing?.priceRange?.start?.gross?.currency === 'INR' ? '₹' : (p.node.pricing?.priceRange?.start?.gross?.currency || '');
                    const formattedPrice = p.node.pricing?.priceRange?.start?.gross?.currency === 'INR' ? `₹${price}` : `${price} ${currency}`;

                    const item = document.createElement("div");
                    item.className = "item px-1";
                    item.innerHTML = `
                        <a href="product.html?id=${p.node.id}" class="block bg-gray-900 shadow rounded-lg hover:shadow-lg hover:shadow-gold/20 transition flex flex-col relative group overflow-hidden cursor-pointer h-full border border-gray-800">
                            <div class="relative">
                                <img src="${p.node.thumbnail?.url || FALLBACK_IMG}" class="w-full h-36 object-cover" alt="${p.node.name}">
                            </div>
                            <div class="p-3 flex flex-col flex-grow">
                                <h3 class="font-semibold text-gray-200 text-sm truncate leading-tight mb-2">${p.node.name}</h3>
                                <div class="mt-auto border-t border-gray-800 pt-2 w-full">
                                    <span class="text-gold font-bold text-base block">${formattedPrice}</span>
                                </div>
                            </div>
                        </a>
                    `;
                    carousel.appendChild(item);
                });

                // Init Owl Carousel
                setTimeout(() => {
                    $('#recommendedCarousel').owlCarousel({
                        loop: products.length > 5, // Only loop if enough items
                        margin: 10,
                        nav: false,
                        dots: true,
                        autoplay: true,
                        autoplayHoverPause: true
                    });
                }, 100);

            } catch (e) {
                console.error("Error drawing recommended:", e);
            }
        }


        function getCart() {
            return JSON.parse(localStorage.getItem("inquiryList") || "[]");
        }

        function saveCart(cart) {
            localStorage.setItem("inquiryList", JSON.stringify(cart));
            updateCartBadge();
            renderCartAction(); // Re-render buttons
        }

        let currentProduct = null;
        let selectedVariant = null;

        function selectVariant(variantId) {
            if (!currentProduct || !currentProduct.variants) return;
            const variant = currentProduct.variants.find(v => v.id === variantId);
            if (variant) {
                selectedVariant = variant;
                // Update Gallery
                renderGallery(variant.media, currentProduct.thumbnail?.url, variant.name);
                // Update Price if needed (optional)
                // Re-render variants to update selection style
                renderVariants(currentProduct.variants);
            }
        }

        async function fetchCollectionProducts(collectionId, currentId) {
            const query = `
            query {
                collection(id: "${collectionId}", channel: "in") {
                    products(first: 20) {
                        edges {
                            node {
                                id
                                name
                                thumbnail { url }
                                pricing {
                                    priceRange {
                                        start {
                                            gross {
                                                amount
                                                currency
                                            }
                                        }
                                    }
                                }
                                category { name }
                            }
                        }
                    }
                }
            }
            `;

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query })
                });
                const json = await res.json();
                const edges = json.data?.collection?.products?.edges || [];
                return edges.map(e => e.node).filter(p => p.id !== currentId);
            } catch (err) {
                console.error(err);
                return [];
            }
        }

        function renderCollectionProducts(products) {
            const container = document.getElementById("collectionCarousel");
            const section = document.getElementById("collectionSection");

            if (products.length === 0) {
                section.classList.add("hidden");
                return;
            }

            section.classList.remove("hidden");

            const html = products.map(p => {
                const price = p.pricing?.priceRange?.start?.gross?.amount?.toFixed(2);
                const currency = p.pricing?.priceRange?.start?.gross?.currency === 'INR' ? '₹' : (p.pricing?.priceRange?.start?.gross?.currency || '');
                const formattedPrice = p.pricing?.priceRange?.start?.gross?.currency === 'INR' ? `₹${price}` : `${price} ${currency}`;

                return `
                <div class="item p-4">
                    <div class="bg-gray-900 rounded-lg shadow hover:shadow-lg hover:shadow-gold/20 transition overflow-hidden cursor-pointer border border-gray-800" onclick="window.location.href='product.html?id=${p.id}'">
                         <div class="relative h-36">
                             <img src="${p.thumbnail?.url || FALLBACK_IMG}" class="w-full h-full object-cover">
                              ${p.category?.name ? `<span class="absolute bottom-2 left-2 bg-black/80 text-white px-2 py-1 text-xs font-bold rounded shadow-sm">${p.category.name}</span>` : ''}
                         </div>
                         <div class="p-4">
                             <h3 class="font-bold text-gray-200 text-lg mb-1 truncate">${p.name}</h3>
                             <p class="text-gold font-bold">${formattedPrice}</p>
                         </div>
                    </div>
                </div>
                `;
            }).join("");

            container.innerHTML = html;

            $('#collectionCarousel').owlCarousel({
                loop: false,
                margin: 20,
                nav: false,
                dots: true,
                responsive: {
                    0: { items: 2 },
                    600: { items: 3 },
                    1000: { items: 5 }
                }
            });
        }

        async function init() {
            if (!productId) {
                showError();
                return;
            }

            currentProduct = await fetchProductDetails(productId);

            if (!currentProduct) {
                showError();
                return;
            }

            renderProduct(currentProduct);

            // Fetch Recommended
            if (currentProduct.category?.name) {
                fetchRecommendedProducts(currentProduct.category.name, currentProduct.id);
            }

            document.getElementById("loadingSpinner").classList.add("hidden");
            document.getElementById("productDetail").classList.remove("hidden");
        }

        function showError() {
            document.getElementById("loadingSpinner").classList.add("hidden");
            document.getElementById("errorContainer").classList.remove("hidden");
        }

        function getCategoryIcon(name) {
            const lowerName = name.toLowerCase();
            if (lowerName.includes('wallpaper')) return 'image-outline';
            if (lowerName.includes('plumbing')) return 'water-outline';
            if (lowerName.includes('fitting')) return 'build-outline';
            if (lowerName.includes('electric')) return 'flash-outline';
            if (lowerName.includes('carpentry')) return 'hammer-outline';
            return 'cube-outline';
        }

        function renderProduct(p) {
            // Meta Badges (Category & Type)
            console.log("Product Metadata:", p.metadata);
            const catName = p.category?.name || "Uncategorized";
            const typeName = p.productType?.name || "Standard";

            document.getElementById("metaContainer").innerHTML = `
                <span class="inline-flex items-center gap-1 bg-gold/10 text-gold text-xs font-bold px-3 py-1 rounded-full border border-gold/20">
                    <ion-icon name="${getCategoryIcon(catName)}"></ion-icon> ${catName}
                </span>
                <span class="inline-flex items-center gap-1 bg-gray-800 text-gray-300 text-xs font-bold px-3 py-1 rounded-full border border-gray-700">
                    <ion-icon name="pricetag-outline"></ion-icon> ${typeName}
                </span>
                <button onclick="shareProduct()" class="inline-flex items-center gap-1 bg-gray-800 hover:bg-gold hover:text-white text-gray-300 transition text-xs font-bold px-3 py-1 rounded-full border border-gray-700 ml-auto">
                    <ion-icon name="share-social-outline" class="text-sm"></ion-icon> Share
                </button>
            `;

            // Name
            document.getElementById("productName").textContent = p.name;

            // Price
            const currentPriceObj = p.pricing?.priceRange?.start?.gross;
            const price = currentPriceObj ? currentPriceObj.amount : null;
            const currency = currentPriceObj ? currentPriceObj.currency : 'INR';

            // Extract "Actual Price" for discount logic
            const actualPriceAttr = p.attributes.find(a => a.attribute.name === "Actual Price");
            const actualPriceStr = actualPriceAttr?.values[0]?.name;

            let priceHtml = "";
            if (actualPriceStr || price) {
                if (actualPriceStr) {
                    priceHtml += `<span class="line-through text-gray-400 text-xl">${actualPriceStr}</span>`;
                }
                if (price) {
                    const formattedPrice = currency === 'INR' ? `₹${price.toFixed(2)}` : `${price.toFixed(2)} ${currency}`;
                    priceHtml += `<span id="productPrice" class="text-gold font-bold text-3xl">${formattedPrice}</span>`;
                }
            }

            // Discount Badge calculation
            if (actualPriceStr && price) {
                const actualVal = parseFloat(actualPriceStr.replace(/[^0-9.]/g, ''));
                if (!isNaN(actualVal) && actualVal > price) {
                    const discount = ((actualVal - price) / actualVal) * 100;
                    priceHtml += `<span class="ml-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm align-top">${Math.round(discount)}% OFF</span>`;
                }
            }

            document.getElementById("priceContainer").innerHTML = priceHtml;


            // Description
            let descText = "";
            if (p.description) {
                descText = p.description;
                if (typeof p.description === 'string' && p.description.startsWith('{')) {
                    try {
                        const descObj = JSON.parse(p.description);
                        if (descObj.blocks) {
                            descText = descObj.blocks.map(b => {
                                if (b.type === 'paragraph') {
                                    return `<p class="mb-2">${b.data.text}</p>`;
                                } else if (b.type === 'list') {
                                    const tag = b.data.style === 'ordered' ? 'ol' : 'ul';
                                    const listClass = b.data.style === 'ordered' ? 'list-decimal' : 'list-disc';
                                    const items = b.data.items.map(i => `<li class="mb-1">${i}</li>`).join('');
                                    return `<${tag} class="${listClass} ml-5 mb-2 pl-2">${items}</${tag}>`;
                                } else if (b.type === 'header') {
                                    return `<h3 class="text-xl font-bold mb-2 mt-4 text-white">${b.data.text}</h3>`;
                                }
                                return '';
                            }).join('');
                        }
                    } catch (e) { }
                }
            }
            document.getElementById("descriptionContainer").innerHTML = descText;

            // Attributes
            let attrsHtml = "";
            const excludeAttrs = ["Actual Price", "Catalogue"]; // Don't show these in list

            p.attributes.forEach(attr => {
                if (excludeAttrs.includes(attr.attribute.name)) return;

                const val = attr.values[0];
                if (!val) return;

                let valHtml = val.name;

                // Check if FILE type
                if (val.file?.url) {
                    valHtml = `<a href="${val.file.url}" target="_blank" class="text-gold hover:underline flex items-center gap-1">View ${val.name} <ion-icon name="open-outline"></ion-icon></a>`;
                }

                attrsHtml += `
                   <div class="flex justify-between py-2 border-b border-gray-100 last:border-0">
                       <span class="font-medium text-gray-700">${attr.attribute.name}</span>
                       <span class="text-gray-500">${valHtml}</span>
                   </div>
                `;
            });
            document.getElementById("attributesContainer").innerHTML = attrsHtml;

            // Catalogue Link
            // Catalogue Links
            let catalogueHtml = "";

            // 1. Check for Attribute-based Catalogue
            const catAttr = p.attributes.find(a => a.attribute.name === "Catalogue");
            if (catAttr && catAttr.values[0]?.file?.url) {
                const url = catAttr.values[0].file.url;
                catalogueHtml += `
                    <a href="${url}" target="_blank" class="block w-full text-center bg-gray-100 text-black font-bold py-3 rounded-lg border border-gold hover:bg-gold transition transform active:scale-95 mb-2">
                        Download Catalogue
                    </a>`;
            }

            // 2. Check for Metadata-based Catalogues (catalogue_x)
            if (p.metadata) {
                const BASE_PDF_URL = "https://pdf-serve.themanagemate.com/files/";
                const catalogues = p.metadata
                    .filter(m => m.key.startsWith("catalogue_"))
                    .sort((a, b) => {
                        const numA = parseInt(a.key.split('_')[1]) || 0;
                        const numB = parseInt(b.key.split('_')[1]) || 0;
                        return numA - numB;
                    });

                catalogues.forEach(cat => {
                    const filename = cat.value;
                    // Extract printable name: remove path, remove extension, replace underscores with spaces
                    const displayName = filename.split('/').pop().replace(/\.[^/.]+$/, "").replace(/_/g, " ");

                    if (filename.startsWith('http')) {
                        catalogueHtml += `
                            <a href="${filename}" target="_blank" class="block w-full text-center bg-gray-100 text-black font-bold py-3 rounded-lg border border-gold hover:bg-gold transition transform active:scale-95 mb-2">
                                View ${displayName}
                            </a>
                        `;
                    } else {
                        catalogueHtml += `
                            <button onclick="openCatalogueViewer('${filename}')" class="block w-full text-center bg-gray-100 text-black font-bold py-3 rounded-lg border border-gold hover:bg-gold transition transform active:scale-95 mb-2">
                                View ${displayName}
                            </button>
                        `;
                    }
                });
            }

            document.getElementById("catalogueContainer").innerHTML = catalogueHtml;

            // Images
            renderGallery(p.media, p.thumbnail?.url, p.name);

            renderCartAction();

            // Set default variant if available
            if (p.variants && p.variants.length > 0) {
                selectedVariant = p.variants[0];
            }
            renderVariants(p.variants);

            // Fetch Collection Products
            if (p.collections && p.collections.length > 0) {
                const collectionId = p.collections[0].id;
                const collectionTitle = p.collections[0].name;
                document.getElementById("collectionTitle").innerText = `More from ${collectionTitle}`;

                fetchCollectionProducts(collectionId, p.id).then(products => {
                    renderCollectionProducts(products);
                });
            }
        }

        function renderCartAction() {
            const cart = getCart();
            const inCart = cart.find(i => i.id === currentProduct.id);

            const actionContainer = document.getElementById("cartActionContainer");

            // prepare price for cart obj
            const priceVal = currentProduct.pricing?.priceRange?.start?.gross?.amount || 0;
            const currency = currentProduct.pricing?.priceRange?.start?.gross?.currency || 'INR';

            if (inCart) {
                // Show Quantity Controls
                actionContainer.innerHTML = `
                 <div class="flex items-center justify-between bg-gray-100 rounded-full p-1 border border-gold">
                    <button class="w-12 h-12 flex items-center justify-center text-gray-600 hover:text-red-500 font-bold text-xl transition" onclick="updateQty('${currentProduct.id}', -1)">-</button>
                    <input type="number" 
                           id="quantityInput" 
                           class="w-16 text-center bg-transparent font-bold text-xl text-gray-800 focus:outline-none" 
                           value="${inCart.quantity}"
                           min="1"
                           step="1"
                           onkeydown="validateQuantityKey(event)"
                           oninput="handleQuantityInput(this, '${currentProduct.id}')"
                           onblur="finalizeQuantity(this, '${currentProduct.id}')">
                    <button class="w-12 h-12 flex items-center justify-center text-gold hover:text-gold-600 font-bold text-xl transition" onclick="updateQty('${currentProduct.id}', 1)">+</button>
                 </div>
                 <div class="mt-2 text-center text-xs text-gray-500">Item is in your cart</div>
                 <button onclick="removeFromCart('${currentProduct.id}')" class="w-full mt-3 bg-red-500 text-white font-bold py-3 rounded-full shadow-lg hover:bg-red-600 hover:shadow-xl transition transform active:scale-95 text-sm flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Remove from Cart
                 </button>
                `;
            } else {
                // Show Add to Cart
                actionContainer.innerHTML = `
                    <button onclick="addToCart()" class="w-full bg-gold text-white font-bold py-4 rounded-full shadow-lg hover:shadow-xl hover:bg-opacity-90 transition transform active:scale-95 text-lg">
                        Add to Inquiry Cart
                    </button>
                `;
            }
        }

        window.addToCart = function () {
            const cart = getCart();
            let priceVal = currentProduct.pricing?.priceRange?.start?.gross?.amount || 0;
            const currency = currentProduct.pricing?.priceRange?.start?.gross?.currency || 'INR';

            // Fallback to Actual Price attribute if price is 0
            if (priceVal === 0 && currentProduct.attributes) {
                const priceAttr = currentProduct.attributes.find(a => a.attribute.name === "Actual Price");
                if (priceAttr && priceAttr.values && priceAttr.values.length > 0) {
                    const parsed = parseFloat(priceAttr.values[0].name.replace(/[^0-9.]/g, ''));
                    if (!isNaN(parsed)) priceVal = parsed;
                }
            }

            const newItem = {
                id: currentProduct.id,
                name: currentProduct.name,
                category: currentProduct.category?.name || '',
                type: currentProduct.productType?.name || '',
                image: currentProduct.thumbnail?.url || FALLBACK_IMG,
                price: priceVal,
                currency: currency,
                quantity: 1
            };
            cart.push(newItem);
            saveCart(cart);
        };

        window.selectVariant = function (variantId) {
            const variant = currentProduct.variants.find(v => v.id === variantId);
            if (!variant) return;

            selectedVariant = variant;

            // Update Price
            const priceObj = variant.pricing?.price?.gross;
            const price = priceObj ? priceObj.amount : 0;
            const currency = priceObj ? priceObj.currency : 'INR';
            const formattedPrice = currency === 'INR' ? `₹${price.toFixed(2)}` : `${price.toFixed(2)} ${currency}`;

            document.getElementById("productPrice").innerText = formattedPrice;

            // Re-render variants to update selection border
            renderVariants(currentProduct.variants);
        };

        function renderVariants(variants) {
            const container = document.getElementById("variantContainer");
            container.innerHTML = "";

            if (!variants || variants.length === 0) return;

            variants.forEach(v => {
                const imgUrl = v.media && v.media.length > 0 ? v.media[0].url : (currentProduct.thumbnail?.url || FALLBACK_IMG);
                const priceObj = v.pricing?.price?.gross;
                const price = priceObj ? priceObj.amount : 0;
                const currency = priceObj ? priceObj.currency : 'INR';
                const formattedPrice = currency === 'INR' ? `₹${price.toFixed(2)}` : `${price.toFixed(2)} ${currency}`;
                const isSelected = selectedVariant && selectedVariant.id === v.id;
                const borderClass = isSelected ? "border-gold ring-1 ring-gold bg-gold/10" : "border-gray-700 bg-gray-900 hover:border-gold/50";

                // Create the card container strictly
                const div = document.createElement("div");
                div.className = `cursor-pointer border ${borderClass} rounded-lg p-2 transition flex flex-col gap-2 group variant-card relative translate-z-0`;
                div.style.zIndex = "10"; // Ensure it catches clicks

                div.innerHTML = `
                    <div class="aspect-square rounded overflow-hidden bg-gray-800 relative pointer-events-none">
                         <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500 pointer-events-none">
                    </div>
                    <div class="text-center pointer-events-none">
                        <p class="text-xs font-bold text-gray-300 truncate mb-1 pointer-events-none">${v.name}</p>
                        <p class="text-gold font-bold text-sm pointer-events-none">${formattedPrice}</p>
                    </div>
                `;

                // Bind click event directly to the element
                div.onclick = function (e) {
                    e.preventDefault(); // Good practice even for divs sometimes
                    window.selectVariant(v.id);
                };

                container.appendChild(div);
            });
        }

        window.updateQty = function (id, delta) {
            let cart = getCart();
            const item = cart.find(i => i.id === id);

            if (item) {
                item.quantity += delta;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== id);
                }
                saveCart(cart);
            }
        };

        window.removeFromCart = function (id) {
            let cart = getCart();
            cart = cart.filter(i => i.id !== id);
            saveCart(cart);
        };

        // Cart Badge Logic
        function updateCartBadge() {
            const badge = document.getElementById("cartCountBadge");
            const list = JSON.parse(localStorage.getItem("inquiryList") || "[]");
            const count = list.length;
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        }
        updateCartBadge();

        // Validate key press - only allow numbers, backspace, delete, arrow keys, tab
        window.validateQuantityKey = function (event) {
            const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
            if (allowedKeys.includes(event.key)) return true;

            // Allow numbers 0-9
            if (/^[0-9]$/.test(event.key)) return true;

            // Prevent everything else (letters, symbols, negative sign, decimal, etc.)
            event.preventDefault();
            return false;
        };

        // Handle input - remove any non-numeric characters and enforce minimum
        window.handleQuantityInput = function (input, productId) {
            // Remove any non-numeric characters
            let value = input.value.replace(/[^0-9]/g, '');

            // Remove leading zeros but keep at least one digit
            value = value.replace(/^0+/, '') || '';

            input.value = value;
        };

        // Finalize quantity on blur - set to 1 if empty or invalid, update cart
        window.finalizeQuantity = function (input, productId) {
            let value = parseInt(input.value, 10);

            // If empty, invalid, zero, or negative, set to 1
            if (isNaN(value) || value <= 0) {
                value = 1;
            }

            input.value = value;

            // Update cart with the new quantity
            let cart = getCart();
            const item = cart.find(i => i.id === productId);

            if (item) {
                item.quantity = value;
                saveCart(cart);
            }
        };


        window.shareProduct = async function () {
            const shareData = {
                title: document.title,
                text: 'Check out this product from B-One Interior!',
                url: window.location.href
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.log('Error sharing:', err);
                }
            } else {
                // Fallback
                try {
                    await navigator.clipboard.writeText(window.location.href);
                    // Use a simple toast or alert if no UI library for toast is present
                    const btn = document.querySelector('ion-icon[name="share-social-outline"]')?.parentElement;
                    if (btn) {
                        const originalText = btn.querySelector('div').innerText;
                        btn.querySelector('div').innerText = "Copied!";
                        setTimeout(() => btn.querySelector('div').innerText = originalText, 2000);
                    } else {
                        alert('Link copied to clipboard!');
                    }
                } catch (err) {
                    console.error('Share failed', err);
                }
            }
        };

        init();

    </script>

    <!-- PDF.js Logic -->
    <script type="module">
        import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.min.mjs';

        let pdfDoc = null; // Represents the CURRENT page's PDF document
        let currentPage = 1;
        let totalPages = 1;
        let isRendering = false;
        let pageNumPending = null;
        let currentFilename = "";
        let rawFilename = ""; // Store full filename with extension for sharing

        // Caching blobs to avoid re-fetching pages

        const pageBlobCache = new Map(); // Key: "filename_page" -> Blob URL
        let zoomLevel = 1.0;

        // Pan State
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        window.openCatalogueViewer = async function (filename) {
            rawFilename = filename; // Store for sharing
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, "").trim();
            currentFilename = nameWithoutExt;
            currentPage = 1;
            zoomLevel = 1.0;
            pageBlobCache.clear();

            const modal = document.getElementById("catalogueModal");
            modal.classList.remove("hidden");
            modal.classList.add("flex");

            // Setup Pan Events
            const container = document.getElementById("catalogueViewer");
            container.innerHTML = `
                 <div id="catalogueLoader" class="absolute inset-0 flex items-center justify-center bg-black/50 z-10 hidden rounded-lg">
                     <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gold"></div>
                 </div>
            `;

            // Attach mouse events for panning
            container.onmousedown = (e) => {
                isDragging = true;
                container.classList.add('active');
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
            };

            container.onmouseleave = () => {
                isDragging = false;
                container.classList.remove('active');
            };

            container.onmouseup = () => {
                isDragging = false;
                container.classList.remove('active');
            };

            container.onmousemove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const y = e.pageY - container.offsetTop;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                container.scrollLeft = scrollLeft - walkX;
                container.scrollTop = scrollTop - walkY;
            };

            await fetchPageCount();
            await loadPageDocument(1);
        };

        window.updateZoom = function (delta) {
            const newZoom = zoomLevel + delta;
            if (newZoom >= 0.5 && newZoom <= 3.0) {
                zoomLevel = newZoom;
                if (currentFilename && currentPage) {
                    loadPageDocument(currentPage);
                }
            }
        };

        window.resetZoom = function () {
            zoomLevel = 1.0;
            if (currentFilename && currentPage) {
                loadPageDocument(currentPage);
            }
        };

        window.closeCatalogue = function () {
            document.getElementById("catalogueModal").classList.add("hidden");
            document.getElementById("catalogueModal").classList.remove("flex");
            zoomLevel = 1.0;
        };

        window.changePage = function (delta) {
            const next = currentPage + delta;
            if (next >= 1 && next <= totalPages) {
                currentPage = next;
                loadPageDocument(next);
            }
        };

        window.shareCatalogue = async function () {
            if (!rawFilename) return;

            // Generate PDF URL that's being displayed (filename without extension + page number)
            const BASE_PDF_URL = "https://pdf-serve.themanagemate.com/fetch-page/";
            const filenameWithoutExt = rawFilename.replace(/\.[^/.]+$/, "");
            const pdfUrl = BASE_PDF_URL + encodeURIComponent(filenameWithoutExt) + "/" + currentPage;

            const shareData = {
                title: 'View Catalogue',
                text: 'Check out this catalogue: ' + rawFilename.replace(/\.[^/.]+$/, "").replace(/_/g, " "),
                url: pdfUrl
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.log('Error sharing:', err);
                }
            } else {
                try {
                    await navigator.clipboard.writeText(pdfUrl);
                    const btn = document.querySelector('button[title="Share Catalogue"]');
                    if (btn) {
                        const icon = btn.querySelector('ion-icon');
                        const originalName = icon.getAttribute('name');
                        icon.setAttribute('name', 'checkmark-outline');
                        setTimeout(() => icon.setAttribute('name', originalName), 2000);
                    }
                    alert('PDF URL copied to clipboard!');
                    console.log(pdfUrl);

                } catch (err) {
                    console.error('Share failed', err);
                }
            }
        };

        async function fetchPageCount() {
            const encodedName = encodeURIComponent(currentFilename);
            try {
                const res = await fetch(`https://pdf-serve.themanagemate.com/list-pdfs/${encodedName}`);
                if (!res.ok) throw new Error("Failed to list PDF info");
                const json = await res.json();
                if (json && json.length > 0) {
                    totalPages = json[0].pageCount || 1;
                } else {
                    totalPages = 1;
                }
            } catch (e) {
                console.error("Error fetching page count:", e);
                totalPages = 1;
            }
            updateUI(currentPage);
        }

        async function loadPageDocument(pageNum) {
            const loader = document.getElementById("catalogueLoader");
            loader.classList.remove("hidden");

            const cacheKey = `${currentFilename}_${pageNum}`;
            let url = "";

            try {
                if (pageBlobCache.has(cacheKey)) {
                    url = pageBlobCache.get(cacheKey);
                } else {
                    const encodedName = encodeURIComponent(currentFilename);
                    const fetchUrl = `https://pdf-serve.themanagemate.com/fetch-page/${encodedName}/${pageNum}`;
                    const res = await fetch(fetchUrl);
                    if (!res.ok) throw new Error("Failed to fetch page");
                    const blob = await res.blob();
                    url = URL.createObjectURL(blob);
                    pageBlobCache.set(cacheKey, url);
                }

                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;

                await renderPageToCanvas(pdf, 1, pageNum);

                updateUI(pageNum);

            } catch (error) {
                console.error("Error loading PDF page:", error);
            } finally {
                loader.classList.add("hidden");
            }
        }

        async function renderPageToCanvas(pdf, pdfPageIndex, globalPageNum) {
            const page = await pdf.getPage(pdfPageIndex);

            // Create Canvas
            const canvas = document.createElement("canvas");
            canvas.className = "shadow-2xl rounded-lg max-h-full max-w-full object-contain";

            const container = document.getElementById("catalogueViewer");
            // Clear content but keep loader
            const loader = document.getElementById("catalogueLoader");
            container.innerHTML = "";
            container.appendChild(loader);
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const viewport = page.getViewport({ scale: 1 });

            // Scale: Fit to container height (Single Page) * zoomLevel
            const containerWidth = container.clientWidth || window.innerWidth * 0.8;
            const containerHeight = container.clientHeight || window.innerHeight * 0.8;

            const hScale = containerHeight / viewport.height;
            const wScale = containerWidth / viewport.width;

            // Base scale is "Fit Within"
            let finalScale = Math.min(hScale, wScale);

            // Apply User Zoom
            finalScale = finalScale * zoomLevel;

            const scaledViewport = page.getViewport({ scale: finalScale });

            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;

            // Enforce overflow behavior on container
            if (zoomLevel > 1.0) {
                container.classList.remove('overflow-hidden');
                container.classList.add('overflow-auto');
                container.style.justifyContent = 'flex-start'; // Allow scrolling
                container.style.alignItems = 'flex-start';
            } else {
                container.classList.add('overflow-hidden');
                container.classList.remove('overflow-auto');
                container.style.justifyContent = 'center'; // Center it
                container.style.alignItems = 'center';
            }

            // CSS to make it responsive but respect zoom
            canvas.style.maxWidth = "none"; // Allow exceeding container width for zoom

            const renderContext = {
                canvasContext: ctx,
                viewport: scaledViewport
            };

            await page.render(renderContext).promise;
        }

        function updateUI(pageNum) {
            const prevBtn = document.getElementById("catPrevBtn");
            const nextBtn = document.getElementById("catNextBtn");

            if (prevBtn) {
                prevBtn.disabled = pageNum <= 1;
                // If disabled, hide interaction
                if (pageNum <= 1) {
                    prevBtn.classList.add("opacity-0", "pointer-events-none");
                } else {
                    prevBtn.classList.remove("opacity-0", "pointer-events-none");
                }
            }

            if (nextBtn) {
                nextBtn.disabled = pageNum >= totalPages;
                if (pageNum >= totalPages) {
                    nextBtn.classList.add("opacity-0", "pointer-events-none");
                } else {
                    nextBtn.classList.remove("opacity-0", "pointer-events-none");
                }
            }

            currentPage = pageNum;
        }
    </script>

    <script src="placeholder.js"></script>
</body>

</html>