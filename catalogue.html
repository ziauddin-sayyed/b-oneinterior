<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Product Catalogues | B-One Interior Store</title>
    <meta property="og:title" content="Product Catalogues | B-One Interior Store">
    <meta property="og:description"
        content="Browse and download product catalogues from B-One Interior. Find detailed specifications and designs for our premium furniture and decor collections.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://b-oneinterior.com/logo.png">
    <meta name="twitter:image" content="https://b-oneinterior.com/logo.png">
    <!-- Tailwind CSS -->
    <script src="assets/js/tailwind.min.js"></script>

    <!-- jQuery + Owl Carousel -->
    <script src="assets/js/jquery.min.js"></script>
    <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
    <link rel="stylesheet" href="assets/css/owl.theme.default.min.css">
    <script src="assets/js/owl.carousel.min.js"></script>
    <script type="module" src="assets/js/ionicons/ionicons.esm.js"></script>

    <link rel="stylesheet" href="style.css?v=1">

    <!-- PDF.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.mjs" type="module"></script>

</head>

<body class="bg-black min-h-[130vh]">

    <!-- Header -->
    <header class="bg-black shadow-lg sticky top-0 z-50 border-b border-gold-700 pt-1">
        <nav class="container mx-auto px-4 py-4 flex items-center justify-between" id="desktop-nav">
            <div class="text-2xl font-bold text-gold-500"><img src="logo.png" style="height: 8vh;" alt=""></div>

            <ul class="hidden md:flex space-x-6 text-gray-300">
                <li><a href="https://b-oneinterior.com/" class="hover:text-gold-500 transition">Home</a></li>
                <li><a href="https://b-oneinterior.com/shop" class="hover:text-gold-500 transition">Shop</a></li>
                <li><a href="https://b-oneinterior.com/company" class="hover:text-gold-500 transition">Services</a></li>
                <li><a href="https://b-oneinterior.com/gallery" class="hover:text-gold-500 transition">Gallery</a></li>
                <li><a href="https://b-oneinterior.com/cart" class="hover:text-gold-500 transition">Cart</a></li>
                <li id="authLinkDesktop"></li>
            </ul>
            <button class="md:hidden text-gold-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
        </nav>

        <div id="drawer">
            <ul>
                <li><a href="https://b-oneinterior.com/company">Company</a></li>
                <li><a href="https://b-oneinterior.com/shop">Shop</a></li>
                <li><a href="https://b-oneinterior.com/company">Services</a></li>
                <li><a href="https://b-oneinterior.com/gallery">Gallery</a></li>
                <li><a href="https://b-oneinterior.com/#contact">Contact Us</a></li>
                <li><a href="terms.html">Terms and Conditions</a></li>
                <li><a href="privacy.html">Privacy Policy</a></li>
                <li id="authLinkDrawer"></li>
            </ul>
        </div>
        <label for="menu-toggle" class="overlay"></label>

        <div class="fixedBottom">
            <a href="https://b-oneinterior.com/" class="logoBx"></a>
            <ul>
                <li>
                    <a href="https://b-oneinterior.com/gallery">
                        <ion-icon name="images-outline"></ion-icon>
                        <div>Gallery</div>
                    </a>
                </li>

                <li>
                    <a href="https://b-oneinterior.com/catalogue">
                        <ion-icon name="document-text-outline"></ion-icon>
                        <div>Catalogue</div>
                    </a>
                </li>


                <li>
                    <a href="https://b-oneinterior.com/login">
                        <ion-icon name="log-in-outline"></ion-icon>
                        <div>Login</div>
                    </a>
                </li>
                <li></li>

                <li>
                    <div class="cursor-pointer" onclick="toggleDrawer()">
                        <ion-icon name="menu-outline" class="text-[#D4AF37] text-2xl"></ion-icon>
                        <div>Menu</div>
                    </div>
                </li>

                <li>
                    <a href="https://b-oneinterior.com/shop">
                        <ion-icon name="storefront-outline"></ion-icon>
                        <div>Shop</div>
                    </a>
                </li>

                <li>
                    <a href="https://b-oneinterior.com/cart">
                        <ion-icon name="cart-outline"></ion-icon>
                        <div>Cart</div>
                        <span id="cartCountBadge" class="absolute -top-2 -right-3 bg-gold text-black text-xs font-bold 
                                w-5 h-5 flex items-center justify-center rounded-full hidden">
                        </span>
                    </a>
                </li>
            </ul>
        </div>

        <script>
            function toggleDrawer() {
                const drawer = document.getElementById("drawer");
                const overlay = document.querySelector(".overlay");
                if (drawer.style.left === "0px") {
                    drawer.style.left = "-250px";
                    overlay.style.opacity = "0";
                    overlay.style.pointerEvents = "none";
                } else {
                    drawer.style.left = "0px";
                    overlay.style.opacity = "1";
                    overlay.style.pointerEvents = "auto";
                }
            }

            const overlay = document.querySelector(".overlay");
            overlay.addEventListener("click", () => {
                const drawer = document.getElementById("drawer");
                drawer.style.left = "-250px";
                overlay.style.opacity = "0";
                overlay.style.pointerEvents = "none";
            });

            // Auth check and navigation update
            function checkAuth() {
                const token = localStorage.getItem('saleor_auth_token');
                const userEmail = localStorage.getItem('saleor_user_email');
                const desktopLink = document.getElementById('authLinkDesktop');
                const drawerLink = document.getElementById('authLinkDrawer');

                if (token && userEmail) {
                    if (desktopLink) {
                        desktopLink.innerHTML = `<a href="#" onclick="signOut()" class="hover:text-gold-500 transition">Sign Out</a>`;
                    }
                    if (drawerLink) {
                        drawerLink.innerHTML = `<a href="#" onclick="signOut()">Sign Out (${userEmail})</a>`;
                    }
                } else {
                    if (desktopLink) {
                        desktopLink.innerHTML = `<a href="login.html" class="hover:text-gold-500 transition">Login</a>`;
                    }
                    if (drawerLink) {
                        drawerLink.innerHTML = `<a href="login.html">Login</a>`;
                    }
                }
            }

            function signOut() {
                localStorage.removeItem('saleor_auth_token');
                localStorage.removeItem('saleor_refresh_token');
                localStorage.removeItem('saleor_csrf_token');
                localStorage.removeItem('saleor_user_email');
                localStorage.removeItem('saleor_user_name');
                window.location.reload();
            }

            document.addEventListener('DOMContentLoaded', checkAuth);
        </script>

        <!-- Search Bar -->
        <div
            class="container mx-auto px-4 flex justify-center sticky top-0 z-40 bg-black py-4 border-b border-gray-800">
            <div class="relative w-full max-w-md">
                <input type="text" id="searchInput" placeholder="Search catalogues..."
                    class="w-full pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:border-gold shadow-sm">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-2 space-y-6">

        <aside class="bg-gray-100 p-1 shadow rounded-lg space-y-2 top-0 z-40">
            <div>
                <h3 class="font-semibold"></h3>
                <div class="overflow-x-auto pb-2 hide-scrollbar">
                    <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </aside>

        <!-- Mobile: Vertical scroll product list -> Grid 2 cols -->
        <div id="mobileProductList" class="grid grid-cols-2 gap-3 md:hidden px-2"></div>

        <!-- Desktop: Grid layout -->
        <main id="productGrid" class="hidden md:grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"></main>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gold"></div>
        </div>

        <!-- Catalogue Viewer Modal -->
        <div id="catalogueModal"
            class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm">

            <!-- Close Button -->
            <button onclick="closeCatalogue()"
                class="absolute top-6 right-6 bg-red-600 text-white rounded-full p-2 z-[200] shadow-lg hover:bg-red-700 transition transform hover:scale-110 flex items-center justify-center">
                <ion-icon name="close-outline" class="text-3xl"></ion-icon>
            </button>

            <!-- Floating Prev Button (Outside) -->
            <button onclick="changePage(-1)" id="catPrevBtn"
                class="absolute left-4 top-1/2 -translate-y-1/2 bg-gray-800/80 text-white hover:bg-gold hover:text-white rounded-full p-4 z-[200] transition transform hover:scale-110 disabled:opacity-0 disabled:pointer-events-none">
                <ion-icon name="chevron-back-outline" class="text-4xl"></ion-icon>
            </button>

            <!-- Floating Next Button (Outside) -->
            <button onclick="changePage(1)" id="catNextBtn"
                class="absolute right-4 top-1/2 -translate-y-1/2 bg-gray-800/80 text-white hover:bg-gold hover:text-white rounded-full p-4 z-[200] transition transform hover:scale-110 disabled:opacity-0 disabled:pointer-events-none">
                <ion-icon name="chevron-forward-outline" class="text-4xl"></ion-icon>
            </button>

            <!-- Zoom Controls -->
            <div class="absolute top-24 right-6 flex flex-col gap-2 z-[200]">
                <button onclick="updateZoom(0.25)"
                    class="bg-gray-800/90 text-white hover:text-gold p-3 rounded-full shadow-lg transition hover:scale-110">
                    <ion-icon name="add-outline" class="text-xl"></ion-icon>
                </button>
                <button onclick="updateZoom(-0.25)"
                    class="bg-gray-800/90 text-white hover:text-gold p-3 rounded-full shadow-lg transition hover:scale-110">
                    <ion-icon name="remove-outline" class="text-xl"></ion-icon>
                </button>
                <button onclick="resetZoom()"
                    class="bg-gray-800/90 text-white hover:text-gold p-3 rounded-full shadow-lg transition hover:scale-110"
                    title="Reset Zoom">
                    <ion-icon name="scan-outline" class="text-xl"></ion-icon>
                </button>
            </div>

            <div class="relative w-full h-full flex flex-col items-center justify-center p-4 content-center">
                <div id="catalogueViewer"
                    class="relative max-w-6xl w-full h-[90vh] flex items-center justify-center bg-gray-900 rounded-lg overflow-hidden border border-gray-800 shadow-2xl cursor-grab active:cursor-grabbing">
                    <!-- Canvas injected here -->
                    <div id="catalogueLoader"
                        class="absolute inset-0 flex items-center justify-center bg-black/50 z-10 hidden rounded-lg">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gold"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_URL = "https://api.b-oneinterior.com/graphql/";
        const HIDDEN_CATEGORY_NAME = "Gallery Image Category";
        const FALLBACK_IMG = "images/placeholder.png";

        const QUERY = `
query {
  categories(first: 100) { 
    edges { 
      node { 
        id 
        name 
        backgroundImage {
            url
        }
        parent { 
          id 
          name 
        } 
      } 
    } 
  }
  products(first: 100, channel: "in") { 
    edges { 
      node { 
        id 
        name 
        slug 
        description
        media {
          url
          type
        }
        attributes {
          attribute {
            name
          }
          values {
            name
            file {
              url
            }
          }
        }
        pricing {
            priceRange {
              start {
                gross {
                  amount
                  currency
                }
              }
            }
        }
        category { 
          id 
          name 
          parent { 
            id 
            name 
          } 
        } 
        productType { 
          id 
          name 
        } 
        thumbnail { 
          url 
        } 
        metadata {
          key
          value
        } 
      } 
    } 
  }
}
`;

        let allCategories = [];
        let allProducts = [];
        let selectedParentCategory = null;

        async function fetchSaleor() {
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query: QUERY })
                });
                const json = await res.json();
                if (json.errors) console.error("GraphQL errors:", json.errors);
                return json.data;
            } catch (err) {
                console.error("Fetch error:", err);
                return null;
            }
        }

        function getCatalogueLink(product) {
            // Priority 1: Check Attributes (Legacy)
            if (product.attributes) {
                const catAttr = product.attributes.find(a => a.attribute.name === "Catalogue");
                if (catAttr && catAttr.values && catAttr.values.length > 0) {
                    return catAttr.values[0].file?.url;
                }
            }

            // Priority 2: Check Metadata (catalogue_X)
            if (product.metadata) {
                // Find any key starting with 'catalogue_'
                // We prioritize 'catalogue_1', but will take others if available
                const catalogues = product.metadata
                    .filter(m => m.key.startsWith("catalogue_"))
                    .sort((a, b) => {
                        // sort by number e.g. catalogue_1 before catalogue_2
                        const numA = parseInt(a.key.split('_')[1]) || 0;
                        const numB = parseInt(b.key.split('_')[1]) || 0;
                        return numA - numB;
                    });

                if (catalogues.length > 0) {
                    return catalogues[0].value;
                }
            }

            return null;
        }

        function getParentCategories(categories) {
            return categories.filter(c => !c.parent && c.name !== HIDDEN_CATEGORY_NAME);
        }

        function getSubcategories(categories, parentId) {
            return categories.filter(c => c.parent?.id === parentId);
        }

        function getCategoryIcon(name) {
            const lowerName = name.toLowerCase();
            if (lowerName.includes('wallpaper')) return 'image-outline';
            if (lowerName.includes('plumbing')) return 'water-outline';
            if (lowerName.includes('fitting')) return 'build-outline';
            if (lowerName.includes('electric')) return 'flash-outline';
            if (lowerName.includes('carpentry')) return 'hammer-outline';
            return 'cube-outline';
        }

        function renderCategoryFilters(categories, products) {
            // Get unique category IDs from products with catalogues
            const productCategoryIds = new Set();
            const productParentCategoryIds = new Set();

            products.forEach(p => {
                if (p.category?.id) productCategoryIds.add(p.category.id);
                if (p.category?.parent?.id) productParentCategoryIds.add(p.category.parent.id);
            });

            // Get parent categories that have products with catalogues
            const parentCategories = getParentCategories(categories).filter(c => {
                // Check if this parent has direct products with catalogues
                if (productCategoryIds.has(c.id)) return true;
                // Check if this parent has subcategories with products that have catalogues
                if (productParentCategoryIds.has(c.id)) return true;
                // Check if any subcategory has products
                const subcats = getSubcategories(categories, c.id);
                return subcats.some(sub => productCategoryIds.has(sub.id));
            });

            document.getElementById("categoryFilter").className = "grid grid-cols-10 gap-2 min-w-[250vw] md:min-w-0 md:w-full";
            document.getElementById("categoryFilter").innerHTML = `
    <div class="filter-category group flex flex-col items-center justify-center cursor-pointer transition ${selectedParentCategory === 'all' || !selectedParentCategory ? 'text-gold' : 'text-gray-500 hover:text-gold'}" data-category="all" data-is-parent="true">
      <ion-icon name="apps-outline" class="text-3xl mb-2"></ion-icon>
      <span class="text-xs font-semibold text-center leading-tight">All</span>
    </div>
    ${parentCategories.map(c => {
                const hasImage = c.backgroundImage?.url;
                const iconHtml = hasImage
                    ? `<img src="${c.backgroundImage.url}" class="w-12 h-12 object-cover mb-2" alt="${c.name}">`
                    : `<ion-icon name="${getCategoryIcon(c.name)}" class="text-3xl mb-2"></ion-icon>`;

                return `
      <div class="filter-category group flex flex-col items-center justify-center cursor-pointer transition ${selectedParentCategory === c.id ? 'text-gold' : 'text-gray-500 hover:text-gold'}" data-category="${c.id}" data-is-parent="true">
        ${iconHtml}
        <span class="text-xs font-semibold text-center leading-tight line-clamp-2">${c.name}</span>
      </div>`;
            }).join("")}
  `;
        }

        function getActualPrice(product) {
            if (!product.attributes) return null;
            const priceAttr = product.attributes.find(a => a.attribute.name === "Actual Price");
            if (priceAttr && priceAttr.values && priceAttr.values.length > 0) {
                return priceAttr.values[0].name;
            }
            return null;
        }

        function renderDesktopList(products) {
            const desktopList = document.getElementById("productGrid");

            desktopList.innerHTML = products.length ? products.map(p => {
                const catalogueVal = getCatalogueLink(p); // Raw value (URL or filename)
                const currentPriceObj = p.pricing?.priceRange?.start?.gross;
                const currentPriceVal = currentPriceObj ? currentPriceObj.amount : null;
                const currency = currentPriceObj ? currentPriceObj.currency : "";

                const price = currentPriceVal?.toFixed(2) || "0.00";
                const currSymbol = currency === 'INR' ? '₹' : (currency || '');
                const formattedPrice = currency === 'INR' ? `₹${price}` : `${price} ${currSymbol}`;

                const imageUrl = p.thumbnail?.url || FALLBACK_IMG;

                let buttonHtml = "";
                if (catalogueVal) {
                    if (catalogueVal.startsWith("http")) {
                        buttonHtml = `
                            <a href="${catalogueVal}" target="_blank"
                             class="w-full block text-center bg-gray-200 text-black text-md font-bold px-3 py-2 rounded-full shadow hover:bg-gray-300 transition cursor-pointer">
                             Download Catalogue
                            </a>`;
                    } else {
                        buttonHtml = `
                            <button onclick="openCatalogueViewer('${catalogueVal}')"
                             class="w-full block text-center bg-gold text-white text-md font-bold px-3 py-2 rounded-full shadow hover:bg-opacity-90 transition cursor-pointer">
                             View Catalogue
                            </button>`;
                    }
                }

                return `
        <div class="block bg-white shadow rounded-lg hover:shadow-lg transition flex flex-col relative group overflow-hidden h-full">
            <a href="product.html?id=${p.id}" class="block">
              <div class="relative">
                  <img src="${imageUrl}" class="w-full h-40 object-cover" alt="${p.name}">
                  ${p.category?.name ? `<div class="absolute bottom-2 left-2 bg-white/90 text-gray-700 text-xs font-bold px-2 py-1 rounded shadow-sm z-10">${p.category.name}</div>` : ''}
              </div>
              
              <div class="p-3 flex flex-col flex-grow">
                  <h3 class="font-semibold text-gray-800 text-sm truncate leading-tight mb-2">${p.name}</h3>
                  <div class="mt-auto border-t pt-2 w-full">
                      <span class="text-black font-bold text-base block">${formattedPrice}</span>
                  </div>
              </div>
            </a>
            <div class="px-3 pb-3">
              ${buttonHtml}
            </div>
        </div>
      `;
            }).join("") : `<p class="col-span-full text-center text-gray-500">No catalogues found.</p>`;
        }

        function renderMobileList(products) {
            const mobileList = document.getElementById("mobileProductList");

            mobileList.innerHTML = products.length ? products.map(p => {
                const catalogueVal = getCatalogueLink(p);
                const currentPriceObj = p.pricing?.priceRange?.start?.gross;
                const currentPriceVal = currentPriceObj ? currentPriceObj.amount : null;
                const currency = currentPriceObj ? currentPriceObj.currency : "";

                let priceHtml = "";
                if (currentPriceVal) {
                    const formattedPrice = currency === 'INR' ? `₹${currentPriceVal.toFixed(2)}` : `${currentPriceVal.toFixed(2)} ${currency}`;
                    priceHtml = `<span class="text-black font-bold text-lg">${formattedPrice}</span>`;
                }

                const imageUrl = p.thumbnail?.url || FALLBACK_IMG;

                let buttonHtml = "";
                if (catalogueVal) {
                    if (catalogueVal.startsWith("http")) {
                        buttonHtml = `
                        <a href="${catalogueVal}" target="_blank"
                          class="w-full flex items-center justify-center bg-gray-200 text-black text-[11px] font-bold px-1 py-2 rounded-full shadow hover:bg-gray-300 transition whitespace-nowrap gap-1 cursor-pointer">
                          <span>Download</span>
                        </a>`;
                    } else {
                        buttonHtml = `
                        <button onclick="openCatalogueViewer('${catalogueVal}')"
                          class="w-full flex items-center justify-center bg-gold text-white text-[11px] font-bold px-1 py-2 rounded-full shadow hover:bg-opacity-90 transition whitespace-nowrap gap-1 cursor-pointer">
                          <span>View Catalogue</span>
                        </button>`;
                    }
                }

                return `
    <div class="bg-white shadow rounded-lg relative group overflow-hidden block">
      <a href="product.html?id=${p.id}" class="block">
        <div class="relative">
            <img src="${imageUrl}" class="w-full h-48 object-cover" alt="${p.name}">
            ${p.category?.name ? `<div class="absolute bottom-2 left-2 bg-white/90 text-gray-700 text-xs font-bold px-2 py-1 rounded shadow-sm z-10">${p.category.name}</div>` : ''}
        </div>
        
        <div class="p-3">
            <h3 class="font-semibold text-gray-800 text-sm truncate leading-tight mb-2">${p.name}</h3>
            
            <div class="flex flex-col gap-2 mt-auto border-t pt-3 w-full">
                ${priceHtml}
            </div>
        </div>
      </a>
      <div class="px-2 pb-3">
        ${buttonHtml}
      </div>
    </div>
  `}).join("") : `<p class="col-span-full text-center text-gray-500">No catalogues found.</p>`;
        }

        function applyFilters() {
            let filtered = allProducts;

            // Filter by Search Query
            const searchQuery = document.getElementById("searchInput").value.toLowerCase();
            if (searchQuery) {
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(searchQuery) ||
                    (p.category && p.category.name.toLowerCase().includes(searchQuery)) ||
                    (p.description && p.description.toLowerCase().includes(searchQuery))
                );
            }

            if (selectedParentCategory && selectedParentCategory !== "all") {
                const subcategories = getSubcategories(allCategories, selectedParentCategory);
                const subcatIds = subcategories.map(s => s.id);

                filtered = filtered.filter(p =>
                    p.category?.id === selectedParentCategory || subcatIds.includes(p.category?.id)
                );
            }

            if (window.innerWidth >= 768) {
                renderDesktopList(filtered);
            } else {
                renderMobileList(filtered);
            }
        }

        function setupFiltering() {
            // Search Input Listener
            document.getElementById("searchInput").addEventListener("input", () => {
                applyFilters();
            });

            document.addEventListener("click", e => {
                if (e.target.closest(".filter-category")) {
                    const target = e.target.closest(".filter-category");
                    document.querySelectorAll(".filter-category").forEach(b => {
                        b.classList.remove("text-gold");
                        b.classList.add("text-gray-500");
                    });
                    target.classList.remove("text-gray-500");
                    target.classList.add("text-gold");

                    selectedParentCategory = target.dataset.category;
                    applyFilters();
                }
            });
        }

        function updateCartBadge() {
            const badge = document.getElementById("cartCountBadge");
            if (!badge) return; // Badge element may not exist

            const list = JSON.parse(localStorage.getItem("inquiryList") || "[]");
            const count = list.length;

            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        }

        (async () => {
            const data = await fetchSaleor();
            if (!data) return alert("Error fetching Saleor API");

            allCategories = data.categories?.edges?.map(e => e.node) || [];
            let products = data.products?.edges?.map(e => e.node) || [];

            // Find the hidden category and all its subcategories
            const hiddenCategory = allCategories.find(c => c.name === HIDDEN_CATEGORY_NAME);
            const hiddenCategoryId = hiddenCategory?.id;
            const hiddenSubcategoryIds = hiddenCategoryId
                ? allCategories.filter(c => c.parent?.id === hiddenCategoryId).map(c => c.id)
                : [];

            // Filter: only products with catalogue AND not in hidden category
            allProducts = products.filter(p => {
                const hasCatalogue = getCatalogueLink(p) !== null;
                if (!hasCatalogue) return false;

                const categoryId = p.category?.id;
                const parentCategoryId = p.category?.parent?.id;

                if (categoryId === hiddenCategoryId) return false;
                if (hiddenSubcategoryIds.includes(categoryId)) return false;
                if (parentCategoryId === hiddenCategoryId) return false;

                return true;
            });

            renderCategoryFilters(allCategories, allProducts);
            applyFilters();
            setupFiltering();
            updateCartBadge();
            document.getElementById("loadingSpinner").classList.add("hidden");
        })();
    </script>

    <!-- PDF.js Logic -->
    <script type="module">
        import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.min.mjs';

        let pdfDoc = null; // Represents the CURRENT page's PDF document
        let currentPage = 1;
        let totalPages = 1;
        let isRendering = false;
        let pageNumPending = null;
        let currentFilename = "";

        // Caching blobs to avoid re-fetching pages

        const pageBlobCache = new Map(); // Key: "filename_page" -> Blob URL
        let zoomLevel = 1.0;

        // Pan State
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        window.openCatalogueViewer = async function (filename) {
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, "").trim();
            currentFilename = nameWithoutExt;
            currentPage = 1;
            zoomLevel = 1.0;
            pageBlobCache.clear();

            const modal = document.getElementById("catalogueModal");
            modal.classList.remove("hidden");
            modal.classList.add("flex");

            // Setup Pan Events
            const container = document.getElementById("catalogueViewer");
            container.innerHTML = `
                 <div id="catalogueLoader" class="absolute inset-0 flex items-center justify-center bg-black/50 z-10 hidden rounded-lg">
                     <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gold"></div>
                 </div>
            `;

            // Attach mouse events for panning
            container.onmousedown = (e) => {
                isDragging = true;
                container.classList.add('active');
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
            };

            container.onmouseleave = () => {
                isDragging = false;
                container.classList.remove('active');
            };

            container.onmouseup = () => {
                isDragging = false;
                container.classList.remove('active');
            };

            container.onmousemove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const y = e.pageY - container.offsetTop;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                container.scrollLeft = scrollLeft - walkX;
                container.scrollTop = scrollTop - walkY;
            };

            await fetchPageCount();
            await loadPageDocument(1);
        };

        window.updateZoom = function (delta) {
            const newZoom = zoomLevel + delta;
            if (newZoom >= 0.5 && newZoom <= 3.0) {
                zoomLevel = newZoom;
                if (currentFilename && currentPage) {
                    loadPageDocument(currentPage);
                }
            }
        };

        window.resetZoom = function () {
            zoomLevel = 1.0;
            if (currentFilename && currentPage) {
                loadPageDocument(currentPage);
            }
        };

        window.closeCatalogue = function () {
            document.getElementById("catalogueModal").classList.add("hidden");
            document.getElementById("catalogueModal").classList.remove("flex");
            zoomLevel = 1.0;
        };

        window.changePage = function (delta) {
            const next = currentPage + delta;
            if (next >= 1 && next <= totalPages) {
                currentPage = next;
                loadPageDocument(next);
            }
        };

        async function fetchPageCount() {
            const encodedName = encodeURIComponent(currentFilename);
            try {
                const res = await fetch(`https://pdf-serve.themanagemate.com/list-pdfs/${encodedName}`);
                if (!res.ok) throw new Error("Failed to list PDF info");
                const json = await res.json();
                if (json && json.length > 0) {
                    totalPages = json[0].pageCount || 1;
                } else {
                    totalPages = 1;
                }
            } catch (e) {
                console.error("Error fetching page count:", e);
                totalPages = 1;
            }
            updateUI(currentPage);
        }

        async function loadPageDocument(pageNum) {
            const loader = document.getElementById("catalogueLoader");
            loader.classList.remove("hidden");

            const cacheKey = `${currentFilename}_${pageNum}`;
            let url = "";

            try {
                if (pageBlobCache.has(cacheKey)) {
                    url = pageBlobCache.get(cacheKey);
                } else {
                    const encodedName = encodeURIComponent(currentFilename);
                    const fetchUrl = `https://pdf-serve.themanagemate.com/fetch-page/${encodedName}/${pageNum}`;
                    const res = await fetch(fetchUrl);
                    if (!res.ok) throw new Error("Failed to fetch page");
                    const blob = await res.blob();
                    url = URL.createObjectURL(blob);
                    pageBlobCache.set(cacheKey, url);
                }

                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;

                await renderPageToCanvas(pdf, 1, pageNum);

                updateUI(pageNum);

            } catch (error) {
                console.error("Error loading PDF page:", error);
            } finally {
                loader.classList.add("hidden");
            }
        }

        async function renderPageToCanvas(pdf, pdfPageIndex, globalPageNum) {
            const page = await pdf.getPage(pdfPageIndex);

            // Create Canvas
            const canvas = document.createElement("canvas");
            canvas.className = "shadow-2xl rounded-lg max-h-full max-w-full object-contain";

            const container = document.getElementById("catalogueViewer");
            // Clear content but keep loader
            const loader = document.getElementById("catalogueLoader");
            container.innerHTML = "";
            container.appendChild(loader);
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const viewport = page.getViewport({ scale: 1 });

            // Scale: Fit to container height (Single Page) * zoomLevel
            const containerWidth = container.clientWidth || window.innerWidth * 0.8;
            const containerHeight = container.clientHeight || window.innerHeight * 0.8;

            const hScale = containerHeight / viewport.height;
            const wScale = containerWidth / viewport.width;

            // Base scale is "Fit Within"
            let finalScale = Math.min(hScale, wScale);

            // Apply User Zoom
            finalScale = finalScale * zoomLevel;

            const scaledViewport = page.getViewport({ scale: finalScale });

            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;

            // Enforce overflow behavior on container
            if (zoomLevel > 1.0) {
                container.classList.remove('overflow-hidden');
                container.classList.add('overflow-auto');
                container.style.justifyContent = 'flex-start'; // Allow scrolling
                container.style.alignItems = 'flex-start';
            } else {
                container.classList.add('overflow-hidden');
                container.classList.remove('overflow-auto');
                container.style.justifyContent = 'center'; // Center it
                container.style.alignItems = 'center';
            }

            // CSS to make it responsive but respect zoom
            canvas.style.maxWidth = "none"; // Allow exceeding container width for zoom

            const renderContext = {
                canvasContext: ctx,
                viewport: scaledViewport
            };

            await page.render(renderContext).promise;
        }

        function updateUI(pageNum) {
            const prevBtn = document.getElementById("catPrevBtn");
            const nextBtn = document.getElementById("catNextBtn");

            if (prevBtn) {
                prevBtn.disabled = pageNum <= 1;
                // If disabled, hide interaction
                if (pageNum <= 1) {
                    prevBtn.classList.add("opacity-0", "pointer-events-none");
                } else {
                    prevBtn.classList.remove("opacity-0", "pointer-events-none");
                }
            }

            if (nextBtn) {
                nextBtn.disabled = pageNum >= totalPages;
                if (pageNum >= totalPages) {
                    nextBtn.classList.add("opacity-0", "pointer-events-none");
                } else {
                    nextBtn.classList.remove("opacity-0", "pointer-events-none");
                }
            }

            currentPage = pageNum;
        }
    </script>

    <script src="placeholder.js"></script>
</body>

</html>