<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Shop Premium Furniture & Decor | B-One Interior Store</title>
  <meta property="og:title" content="Shop Premium Furniture & Decor | B-One Interior Store">
  <meta property="og:description"
    content="Browse our extensive catalog of high-quality furniture and home decor. Find the perfect pieces to elevate your living space with B-One Interior's curated collection.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:image" content="https://b-oneinterior.com/logo.png">
  <meta name="twitter:image" content="https://b-oneinterior.com/logo.png">
  <!-- Tailwind CSS -->
  <script src="assets/js/tailwind.min.js"></script>

  <!-- jQuery + Owl Carousel -->
  <script src="assets/js/jquery.min.js"></script>
  <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
  <link rel="stylesheet" href="assets/css/owl.theme.default.min.css">
  <script src="assets/js/owl.carousel.min.js"></script>
  <script type="module" src="assets/js/ionicons/ionicons.esm.js"></script>

  <link rel="stylesheet" href="style.css?v=1">


</head>

<body class="bg-black min-h-[130vh]">

  <!-- Header -->
  <header class="bg-black sticky shadow-lg top-0 z-50 border-b border-gold-700 pt-1">
    <nav class="container mx-auto px-4 py-4 flex items-center justify-between" id="desktop-nav">
      <div class="text-2xl font-bold text-gold-500"><img src="logo.png" style="height: 8vh;" alt=""></div>

      <ul class="hidden md:flex space-x-6 text-gray-300">
        <li><a href="https://b-oneinterior.com/" class="hover:text-gold-500 transition">Home</a></li>
        <li><a href="https://b-oneinterior.com/shop" class="hover:text-gold-500 transition">Shop</a></li>
        <li><a href="https://b-oneinterior.com/company" class="hover:text-gold-500 transition">Services</a></li>
        <li><a href="https://b-oneinterior.com/gallery" class="hover:text-gold-500 transition">Gallery</a></li>
        <li><a href="https://b-oneinterior.com/cart" class="hover:text-gold-500 transition">Cart</a></li>
        <li id="authLinkDesktop"></li>
      </ul>
      <button class="md:hidden text-gold-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </nav>



    <!-- Search Bar -->
    <div class="container mx-auto px-4 flex justify-center sticky top-0 z-40 bg-black py-4 border-b border-gray-800">
      <div class="relative w-full max-w-md">
        <input type="text" id="searchInput" placeholder="Search products..."
          class="w-full pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:border-gold shadow-sm">
        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
    </div>

    <div id="drawer">
      <ul>
        <li><a href="https://b-oneinterior.com/company">Company</a></li>
        <li><a href="https://b-oneinterior.com/shop">Shop</a></li>
        <li><a href="https://b-oneinterior.com/company">Services</a></li>
        <li><a href="https://b-oneinterior.com/gallery">Gallery</a></li>
        <li><a href="https://b-oneinterior.com/#contact">Contact Us</a></li>
        <li><a href="terms.html">Terms and Conditions</a></li>
        <li><a href="privacy.html">Privacy Policy</a></li>
        <li id="authLinkDrawer"></li>
      </ul>
    </div>
    <label for="menu-toggle" class="overlay"></label>

    <div class="fixedBottom">
      <a href="https://b-oneinterior.com/" class="logoBx"></a>
      <ul>
        <li>
          <a href="https://b-oneinterior.com/gallery">
            <ion-icon name="images-outline"></ion-icon>
            <div>Gallery</div>
          </a>
        </li>

        <li>
          <a href="https://b-oneinterior.com/catalogue">
            <ion-icon name="document-text-outline"></ion-icon>
            <div>Catalogue</div>
          </a>
        </li>

        <li>
          <a href="https://b-oneinterior.com/login">
            <ion-icon name="log-in-outline"></ion-icon>
            <div>Login</div>
          </a>
        </li>
        <li></li>

        <li>
          <div class="cursor-pointer" onclick="toggleDrawer()">
            <ion-icon name="menu-outline" class="text-[#D4AF37] text-2xl"></ion-icon>
            <div>Menu</div>
          </div>
        </li>

        <li>
          <a href="https://b-oneinterior.com/shop">
            <ion-icon name="storefront-outline"></ion-icon>
            <div>Shop</div>
          </a>
        </li>

        <li>
          <a href="https://b-oneinterior.com/cart">
            <ion-icon name="cart-outline"></ion-icon>
            <div>Cart</div>
            <span id="cartCountBadge" class="absolute -top-2 -right-3 bg-gold text-black text-xs font-bold 
                                w-5 h-5 flex items-center justify-center rounded-full hidden">
            </span>
          </a>
        </li>
      </ul>
    </div>

    <script>
      function toggleDrawer() {
        const drawer = document.getElementById("drawer");
        const overlay = document.querySelector(".overlay");
        if (drawer.style.left === "0px") {
          drawer.style.left = "-250px";
          overlay.style.opacity = "0";
          overlay.style.pointerEvents = "none";
        } else {
          drawer.style.left = "0px";
          overlay.style.opacity = "1";
          overlay.style.pointerEvents = "auto";
        }
      }

      const overlay = document.querySelector(".overlay");
      overlay.addEventListener("click", () => {
        const drawer = document.getElementById("drawer");
        drawer.style.left = "-250px";
        overlay.style.opacity = "0";
        overlay.style.pointerEvents = "none";
      });

      // Auth check and navigation update
      function checkAuth() {
        const token = localStorage.getItem('saleor_auth_token');
        const userEmail = localStorage.getItem('saleor_user_email');
        const desktopLink = document.getElementById('authLinkDesktop');
        const drawerLink = document.getElementById('authLinkDrawer');

        if (token && userEmail) {
          if (desktopLink) {
            desktopLink.innerHTML = `<a href="#" onclick="signOut()" class="hover:text-gold-500 transition">Sign Out</a>`;
          }
          if (drawerLink) {
            drawerLink.innerHTML = `<a href="#" onclick="signOut()">Sign Out (${userEmail})</a>`;
          }
        } else {
          if (desktopLink) {
            desktopLink.innerHTML = `<a href="login.html" class="hover:text-gold-500 transition">Login</a>`;
          }
          if (drawerLink) {
            drawerLink.innerHTML = `<a href="login.html">Login</a>`;
          }
        }
      }

      function signOut() {
        localStorage.removeItem('saleor_auth_token');
        localStorage.removeItem('saleor_refresh_token');
        localStorage.removeItem('saleor_csrf_token');
        localStorage.removeItem('saleor_user_email');
        localStorage.removeItem('saleor_user_name');
        localStorage.removeItem('saleor_user_is_staff');
        window.location.reload();
      }

      document.addEventListener('DOMContentLoaded', checkAuth);

      // Helper function to check if user is logged in
      function isUserLoggedIn() {
        const token = localStorage.getItem('saleor_auth_token');
        return !!token;
      }
    </script>
  </header>

  <div class="container mx-auto p-2  space-y-6">

    <aside class="bg-gray-100 p-1 shadow rounded-lg space-y-2  top-0 z-40">
      <div>
        <h3 class="font-semibold"></h3>
        <div class="overflow-x-auto pb-2 hide-scrollbar">
          <div id="categoryFilter" class="flex flex-wrap gap-2"></div>
        </div>
        <hr>
        <div id="subcategoryFilter" class="flex flex-wrap gap-2 mt-3 hidden">

        </div>
      </div>
    </aside>

    <!-- Mobile: Vertical scroll product list -> Grid 2 cols -->
    <div id="mobileProductList" class="grid grid-cols-2 gap-3 md:hidden px-2"></div>

    <!-- Desktop: Grid layout -->
    <main id="productGrid" class="hidden md:grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"></main>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gold"></div>
    </div>

  </div>

  <script>
    const API_URL = "https://api.b-oneinterior.com/graphql/";
    const HIDDEN_CATEGORY_NAME = "Gallery Image Category";
    const FALLBACK_IMG = "images/placeholder.png";

    // Updated query to fetch parent category information and product attributes
    function getGraphqlQuery(isStaff) {
      const variantChannelListings = isStaff ? `
          channelListings {
            channel {
              name
              currencyCode
            }
            price {
              amount
              currency
            }
            costPrice {
              amount
              currency
            }
          }
        ` : '';

      return `
query {
  categories(first: 100) { 
    edges { 
      node { 
        id 
        name 
        backgroundImage {
            url
        }
        parent { 
          id 
          name 
        } 
      } 
    } 
  }
  products(first: 100, channel: "in", filter: { isPublished: true }) { 
    edges { 
      node { 
        id 
        name 
        slug 
        description
        media {
          url
          type
        }
        attributes {
          attribute {
            name
          }
          values {
            name
            file {
              url
            }
          }
        }
        pricing {
            priceRange {
              start {
                gross {
                  amount
                  currency
                }
              }
            }
        }
        variants {
          id
          name
          sku
          ${variantChannelListings}
        }
        category { 
          id 
          name 
          parent { 
            id 
            name 
          } 
        } 
        productType { 
          id 
          name 
        } 
        thumbnail { 
          url 
        } 
      } 
    } 
  }
}
`;
    }

    let allCategories = [];
    let allProducts = [];
    let selectedParentCategory = null;

    async function fetchSaleor(retry = true) {
      try {
        const token = localStorage.getItem('saleor_auth_token');
        const headers = {
          "Content-Type": "application/json"
        };
        if (token) {
          headers["Authorization"] = `Bearer ${token}`;
        }

        const isStaff = token && localStorage.getItem('saleor_user_is_staff') === 'true';
        const res = await fetch(API_URL, {
          method: "POST",
          headers: headers,
          body: JSON.stringify({ query: getGraphqlQuery(isStaff) })
        });
        const json = await res.json();

        if (json.errors) {
          const isExpired = json.errors.some(e => e.message === "Signature has expired" || e.extensions?.exception?.code === "ExpiredSignatureError");
          if (isExpired && retry) {
            console.log("Token expired, attempting refresh...");
            const refreshed = await refreshToken();
            if (refreshed) {
              return fetchSaleor(false); // Retry once
            } else {
              console.log("Refresh failed, signing out...");
              signOut(); // Force logout if refresh fails
            }
          }
          console.error("GraphQL errors:", json.errors);
        }
        return json.data;
      } catch (err) {
        console.error("Fetch error:", err);
        return null;
      }
    }

    async function refreshToken() {
      const refreshToken = localStorage.getItem('saleor_refresh_token');
      if (!refreshToken) return false;

      const mutation = `
            mutation {
                tokenRefresh(refreshToken: "${refreshToken}") {
                    token
                    errors {
                        field
                        message
                    }
                }
            }
        `;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: mutation })
        });
        const json = await res.json();
        if (json.data?.tokenRefresh?.token) {
          localStorage.setItem('saleor_auth_token', json.data.tokenRefresh.token);
          return true;
        }
      } catch (e) {
        console.error("Error refreshing token:", e);
      }
      return false;
    }

    function getParentCategories(categories) {
      return categories.filter(c => !c.parent && c.name !== HIDDEN_CATEGORY_NAME);
    }

    function getSubcategories(categories, parentId) {
      return categories.filter(c => c.parent?.id === parentId);
    }

    function getCategoryCounts(products, categoryId) {
      return products.filter(p => {
        // Count products that belong to this category or have this category as parent
        return p.category?.id === categoryId || p.category?.parent?.id === categoryId;
      }).length;
    }

    function getCategoryIcon(name) {
      const lowerName = name.toLowerCase();
      if (lowerName.includes('wallpaper')) return 'image-outline';
      if (lowerName.includes('plumbing')) return 'water-outline';
      if (lowerName.includes('fitting')) return 'build-outline';
      if (lowerName.includes('electric')) return 'flash-outline';
      if (lowerName.includes('carpentry')) return 'hammer-outline';
      return 'cube-outline'; // Default generic icon
    }

    function renderCategoryFilters(categories, products) {
      const parentCategories = getParentCategories(categories);

      // Calculate counts for parent categories (including their subcategories' products)
      const parentCounts = {};
      parentCategories.forEach(parent => {
        const subcats = getSubcategories(categories, parent.id);
        const subcatIds = subcats.map(s => s.id);
        parentCounts[parent.id] = products.filter(p =>
          p.category?.id === parent.id || subcatIds.includes(p.category?.id)
        ).length;
      });

      document.getElementById("categoryFilter").className = "grid grid-cols-10 gap-2 min-w-[250vw] md:min-w-0 md:w-full";
      document.getElementById("categoryFilter").innerHTML = `
    <div class="filter-category group flex flex-col items-center justify-center cursor-pointer transition ${selectedParentCategory === 'all' ? 'text-gold' : 'text-gray-500 hover:text-gold'}" data-category="all" data-is-parent="true">
      <ion-icon name="apps-outline" class="text-3xl mb-2"></ion-icon>
      <span class="text-xs font-semibold text-center leading-tight">All</span>
    </div>
    ${parentCategories.map(c => {
        const hasImage = c.backgroundImage?.url;
        const iconHtml = hasImage
          ? `<img src="${c.backgroundImage.url}" class="w-12 h-12 object-cover mb-2" alt="${c.name}">`
          : `<ion-icon name="${getCategoryIcon(c.name)}" class="text-3xl mb-2"></ion-icon>`;

        return `
      <div class="filter-category group flex flex-col items-center justify-center cursor-pointer transition ${selectedParentCategory === c.id ? 'text-gold' : 'text-gray-500 hover:text-gold'}" data-category="${c.id}" data-is-parent="true">
        ${iconHtml}
        <span class="text-xs font-semibold text-center leading-tight line-clamp-2">${c.name}</span>
      </div>`;
      }).join("")}
  `;

      // Hide subcategory filter initially
      document.getElementById("subcategoryFilter").classList.add("hidden");
      document.getElementById("subcategoryFilter").innerHTML = "";
    }

    function renderSubcategoryFilters(parentId) {
      const subcategories = getSubcategories(allCategories, parentId);
      const subcategoryContainer = document.getElementById("subcategoryFilter");

      if (subcategories.length === 0) {
        subcategoryContainer.classList.add("hidden");
        subcategoryContainer.innerHTML = "";
        return;
      }

      // Calculate counts for subcategories
      const subcatCounts = {};
      subcategories.forEach(sub => {
        subcatCounts[sub.id] = allProducts.filter(p => p.category?.id === sub.id).length;
      });

      // Get parent products count (products directly in parent, not in subcategories)
      const parentDirectCount = allProducts.filter(p => p.category?.id === parentId).length;
      const allInParentCount = allProducts.filter(p =>
        p.category?.id === parentId || subcategories.map(s => s.id).includes(p.category?.id)
      ).length;

      subcategoryContainer.innerHTML = `
    <button class="filter-subcategory px-3 py-1 rounded-full border text-sm bg-gold text-white" data-subcategory="all">
      All (${allInParentCount})
    </button>
    ${subcategories.map(s => `
      <button class="filter-subcategory px-3 py-1 rounded-full border border-gray-300 text-gray-700 text-sm" data-subcategory="${s.id}">
        ${s.name} (${subcatCounts[s.id] || 0})
      </button>`).join("")}
  `;

      subcategoryContainer.classList.remove("hidden");
    }

    function getActualPrice(product) {
      if (!product.attributes) return null;
      const priceAttr = product.attributes.find(a => a.attribute.name === "Actual Price");
      if (priceAttr && priceAttr.values && priceAttr.values.length > 0) {
        return priceAttr.values[0].name;
      }
      return null;
    }

    function getCatalogueLink(product) {
      if (!product.attributes) return null;
      const catAttr = product.attributes.find(a => a.attribute.name === "Catalogue");
      if (catAttr && catAttr.values && catAttr.values.length > 0) {
        return catAttr.values[0].file?.url;
      }
      return null;
    }

    // Get cost price from "Cost Price" attribute
    function getCostPrice(product) {
      if (!product.attributes) return null;
      const costPriceAttr = product.attributes.find(a => a.attribute.name === "Cost Price");
      if (costPriceAttr && costPriceAttr.values && costPriceAttr.values.length > 0) {
        const costPriceStr = costPriceAttr.values[0].name;
        const parsed = parseFloat(costPriceStr.replace(/[^0-9.]/g, ''));
        return !isNaN(parsed) ? parsed : null;
      }
      return null;
    }

    function generateCartBtnHtml(p, cart) {
      const inCart = cart.find(i => i.id === p.id);
      const currentPriceObj = p.pricing?.priceRange?.start?.gross;
      let price = currentPriceObj ? currentPriceObj.amount : 0;
      const currency = currentPriceObj ? currentPriceObj.currency : 'INR';

      if (price === 0) {
        // Fallback to Actual Price attribute if available
        const actualPriceStr = getActualPrice(p);
        if (actualPriceStr) {
          const parsed = parseFloat(actualPriceStr.replace(/[^0-9.]/g, ''));
          if (!isNaN(parsed)) price = parsed;
        }
      }

      if (inCart) {
        return `
              <div class="flex items-center justify-between rounded-full bg-gray-100 min-w-0 border border-gold w-full">
                  <button class="qty-minus px-2 py-2 text-gray-600 hover:text-red-500 font-bold text-sm leading-none flex-1 flex items-center justify-center" data-id="${p.id}">-</button>
                  <input type="number" min="1" class="qty-input w-12 text-center text-sm font-bold text-gray-800 bg-transparent border-none focus:ring-0 p-0" value="${inCart.quantity || 1}" data-id="${p.id}">
                  <button class="qty-plus px-2 py-2 text-gold hover:text-gold-600 font-bold text-sm leading-none flex-1 flex items-center justify-center" data-id="${p.id}">+</button>
              </div>
            `;
      } else {
        return `
               <button class="add-to-cart-btn w-full py-2 rounded-full text-xs font-medium bg-gold text-white hover:opacity-90 min-w-0"
                    data-id="${p.id}"
                    data-name="${p.name}"
                    data-category="${p.category?.name || ''}"
                    data-type="${p.productType?.name || ''}"
                    data-image="${p.thumbnail?.url || FALLBACK_IMG}"
                    data-price="${price}"
                    data-currency="${currency}">
                Add to Cart
              </button>
            `;
      }
    }

    function getVariantPricing(product) {
      if (product.variants && product.variants.length > 0) {
        const variant = product.variants[0]; // Use first variant
        if (variant.channelListings && variant.channelListings.length > 0) {
          const listing = variant.channelListings[0]; // Use first listing
          return {
            price: listing.price,
            costPrice: listing.costPrice
          };
        }
      }
      return null;
    }

    function renderDesktopList(products) {
      const desktopList = document.getElementById("productGrid"); // Changed to productGrid as per original renderGrid
      const cart = getCart();
      const loggedIn = isUserLoggedIn();

      desktopList.innerHTML = products.length ? products.map(p => {
        const variantPricing = getVariantPricing(p);
        let sellingPrice = 0;
        let costPrice = null;
        let currency = 'INR';

        if (variantPricing) {
          sellingPrice = variantPricing.price?.amount || 0;
          currency = variantPricing.price?.currency || 'INR';
          costPrice = variantPricing.costPrice?.amount || null;
        } else {
          const currentPriceObj = p.pricing?.priceRange?.start?.gross;
          sellingPrice = currentPriceObj ? currentPriceObj.amount : 0;
          currency = currentPriceObj ? currentPriceObj.currency : 'INR';
          if (costPrice === null) {
            const attrCost = getCostPrice(p);
            if (attrCost !== null) costPrice = attrCost;
          }
        }

        const currSymbol = currency === 'INR' ? '₹' : (currency || '');
        const formattedSellingPrice = currency === 'INR' ? `₹${sellingPrice.toFixed(2)}` : `${sellingPrice.toFixed(2)} ${currSymbol}`;
        const formattedCostPrice = costPrice !== null ? (currency === 'INR' ? `₹${costPrice.toFixed(2)}` : `${costPrice.toFixed(2)} ${currSymbol}`) : '';
        const imageUrl = p.thumbnail?.url || FALLBACK_IMG;

        return `
        <a href="product.html?id=${p.id}" class="block bg-white shadow rounded-lg hover:shadow-lg transition flex flex-col relative group overflow-hidden cursor-pointer h-full">
            <div class="relative">
                <img src="${imageUrl}" class="w-full h-40 object-cover" alt="${p.name}">
                ${p.category?.name ? `<div class="absolute bottom-2 left-2 bg-white/90 text-gray-700 text-xs font-bold px-2 py-1 rounded shadow-sm z-10">${p.category.name}</div>` : ''}
            </div>
            
            <div class="p-3 flex flex-col flex-grow">
                <h3 class="font-semibold text-gray-800 text-sm truncate leading-tight mb-2">${p.name}</h3>
                <div class="mt-auto border-t pt-2 w-full">                    
                    ${(loggedIn && costPrice !== null) ? `<span class="text-black font-bold text-base block">${formattedCostPrice}</span>` : `<span class="text-black font-bold text-base block">${formattedSellingPrice}</span>`}
                </div>
            </div>
        </a>
      `;
      }).join("") : `<p class="col-span-full text-center text-gray-500">No products found.</p>`;
    }

    function renderMobileList(products) {
      const mobileList = document.getElementById("mobileProductList");
      const cart = getCart();
      const loggedIn = isUserLoggedIn();

      mobileList.innerHTML = products.length ? products.map(p => {
        // Variant Pricing Logic
        const variantPricing = getVariantPricing(p);
        let sellingPrice = 0;
        let costPrice = null;
        let currency = 'INR';

        if (variantPricing) {
          sellingPrice = variantPricing.price?.amount || 0;
          currency = variantPricing.price?.currency || 'INR';
          costPrice = variantPricing.costPrice?.amount || null;
        } else {
          const currentPriceObj = p.pricing?.priceRange?.start?.gross;
          sellingPrice = currentPriceObj ? currentPriceObj.amount : 0;
          currency = currentPriceObj ? currentPriceObj.currency : 'INR';
          if (costPrice === null) {
            const attrCost = getCostPrice(p);
            if (attrCost !== null) costPrice = attrCost;
          }
        }

        const actualPriceStr = getActualPrice(p);
        const catalogueUrl = getCatalogueLink(p);

        // Map to old variable name if necessary for existing logic not yet updated? 
        // No, I will update the logic in next steps.
        // But for now, I should keep currentPriceVal defined to avoid breaking subsequent code before I update it.
        const currentPriceVal = sellingPrice;

        const cartBtnHtml = generateCartBtnHtml(p, cart);

        let priceHtml = "";
        let badgeHtml = "";
        let catalogueBadgeHtml = "";

        if (catalogueUrl) {
          catalogueBadgeHtml = `<a href="${catalogueUrl}" target="_blank" class="block text-center bg-gray-100 text-gold text-xs font-bold px-2 py-2 rounded shadow-sm hover:bg-gold hover:text-white transition cursor-pointer mb-2 border border-gold">View Catalogue</a>`;
        }

        const isStaff = localStorage.getItem('saleor_user_is_staff') === 'true';

        if (loggedIn && costPrice !== null) {
          // Show cost price for ANY logged-in users
          const formattedCostPrice = currency === 'INR' ? `₹${costPrice.toFixed(2)}` : `${costPrice.toFixed(2)} ${currency}`;
          const formattedSellingPrice = currency === 'INR' ? `₹${currentPriceVal?.toFixed(2) || "0.00"}` : `${currentPriceVal?.toFixed(2) || "0.00"} ${currency}`;

          priceHtml = `<div class="w-full flex flex-col items-center justify-center gap-1 leading-tight">
            <span class="text-black font-bold text-base block">${formattedCostPrice}</span>
          </div>`;
        } else {
          // Calculate Discount for non-logged-in users
          if (actualPriceStr && currentPriceVal) {
            const actualVal = parseFloat(actualPriceStr.replace(/[^0-9.]/g, ''));
            if (!isNaN(actualVal) && actualVal > currentPriceVal) {
              const discount = ((actualVal - currentPriceVal) / actualVal) * 100;
              if (discount > 0) {
                badgeHtml = `<div class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm z-10">${Math.round(discount)}% OFF</div>`;
              }
            }
          }

          // Build Price HTML for non-logged-in users
          if (actualPriceStr || currentPriceVal) {
            priceHtml = `<div class="w-full flex items-baseline justify-center gap-2 leading-tight">`;
            if (actualPriceStr) {
              priceHtml += `<span class="line-through text-gray-400 text-xs">${actualPriceStr}</span>`;
            }
            if (currentPriceVal) {
              const formattedPrice = currency === 'INR' ? `₹${currentPriceVal.toFixed(2)}` : `${currentPriceVal.toFixed(2)} ${currency}`;
              priceHtml += `<span class="text-black font-bold text-lg">${formattedPrice}</span>`;
            }
            priceHtml += `</div>`;
          }
        }

        // Description Logic
        let descHtml = "";
        if (p.description) {
          let descText = p.description;
          // Simple basic cleaning if it's stringified JSON structure
          if (typeof p.description === 'string' && p.description.startsWith('{')) {
            try {
              const descObj = JSON.parse(p.description);
              if (descObj.blocks) {
                descText = descObj.blocks.map(b => b.data.text).join(' ');
              }
            } catch (e) { }
          }
          if (descText.length > 100) {
            descText = descText.substring(0, 100) + "...";
          }
          descHtml = `<p class="text-xs text-gray-600 mt-2 mb-2 line-clamp-3">${descText}</p>`;
        }

        // Image Carousel Logic
        let imageHtml = "";
        if (p.media && p.media.length > 0) {
          imageHtml = `<div class="owl-carousel product-carousel">`;
          p.media.forEach(m => {
            if (m.type === 'IMAGE') {
              imageHtml += `<img src="${m.url}" class="w-full h-48 object-cover" alt="${p.name}">`;
            }
          });
          imageHtml += `</div>`;
        } else {
          imageHtml = `<img src="${p.thumbnail?.url || FALLBACK_IMG}" class="w-full h-48 object-cover" alt="${p.name}">`;
        }

        return `
    <a href="product.html?id=${p.id}" class="bg-white shadow rounded-lg relative group overflow-hidden cursor-pointer block">
      <div class="relative">
          ${imageHtml}
          <!-- Category Badge (Bottom Left) -->
          ${p.category?.name ? `<div class="absolute bottom-2 left-2 bg-white/90 text-gray-700 text-xs font-bold px-2 py-1 rounded shadow-sm z-10">${p.category.name}</div>` : ''}
      </div>
      
      <div class="p-3">
          <h3 class="font-semibold text-gray-800 text-sm truncate leading-tight mb-2">${p.name}</h3>
          
          <div class="flex flex-col-reverse gap-2 mt-auto border-t pt-3 w-full">
              ${priceHtml}
          </div>
      </div>
    </a>
  `}).join("") : `<p class="col-span-full text-center text-gray-500">No products found.</p>`;

      // Initialize Carousel
      setTimeout(() => {
        $('.product-carousel').owlCarousel({
          items: 1,
          loop: true,
          dots: true,
          nav: false,
          margin: 10
        });
      }, 100);
    }

    function applyFilters() {
      const activeSubcat = document.querySelector(".filter-subcategory.bg-gold")?.dataset.subcategory;
      let filtered = allProducts;

      // Filter by Search Query (product name, description, and variant names)
      const searchQuery = document.getElementById("searchInput").value.toLowerCase();
      if (searchQuery) {
        filtered = filtered.filter(p => {
          // Check product name
          if (p.name.toLowerCase().includes(searchQuery)) return true;
          // Check category name
          if (p.category && p.category.name.toLowerCase().includes(searchQuery)) return true;
          // Check description
          if (p.description && p.description.toLowerCase().includes(searchQuery)) return true;
          // Check variant names
          if (p.variants && p.variants.length > 0) {
            const hasMatchingVariant = p.variants.some(v =>
              v.name && v.name.toLowerCase().includes(searchQuery)
            );
            if (hasMatchingVariant) return true;
          }
          return false;
        });
      }

      if (selectedParentCategory && selectedParentCategory !== "all") {
        const subcategories = getSubcategories(allCategories, selectedParentCategory);
        const subcatIds = subcategories.map(s => s.id);

        if (activeSubcat && activeSubcat !== "all") {
          // Filter by specific subcategory
          filtered = filtered.filter(p => p.category?.id === activeSubcat);
        } else {
          // Filter by parent category or any of its subcategories
          filtered = filtered.filter(p =>
            p.category?.id === selectedParentCategory || subcatIds.includes(p.category?.id)
          );
        }
      }
      if (window.innerWidth >= 768) {
        renderDesktopList(filtered);
      } else {
        renderMobileList(filtered);
      }
    }

    function setupFiltering() {
      // Search Input Listener
      document.getElementById("searchInput").addEventListener("input", () => {
        applyFilters();
      });

      document.addEventListener("click", e => {
        // Handle parent category clicks
        if (e.target.closest(".filter-category")) {
          const target = e.target.closest(".filter-category");
          document.querySelectorAll(".filter-category").forEach(b => {
            b.classList.remove("text-gold");
            b.classList.add("text-gray-500");
          });
          target.classList.remove("text-gray-500");
          target.classList.add("text-gold");

          selectedParentCategory = target.dataset.category;

          if (selectedParentCategory === "all") {
            document.getElementById("subcategoryFilter").classList.add("hidden");
            document.getElementById("subcategoryFilter").innerHTML = "";
          } else {
            renderSubcategoryFilters(selectedParentCategory);
          }

          applyFilters();
        }

        // Handle subcategory clicks
        if (e.target.classList.contains("filter-subcategory")) {
          document.querySelectorAll(".filter-subcategory").forEach(b => b.classList.remove("bg-gold", "text-white"));
          e.target.classList.add("bg-gold", "text-white");
          applyFilters();
        }
      });
    }

    function getCart() {
      return JSON.parse(localStorage.getItem("inquiryList") || "[]");
    }

    function saveCart(cart) {
      localStorage.setItem("inquiryList", JSON.stringify(cart));
      updateCartBadge();
    }

    function updateProductCartUI(productId) {
      const cart = getCart();
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;

      const newHtml = generateCartBtnHtml(product, cart);
      const wrappers = document.querySelectorAll(`.cart-btn-wrapper[data-id="${productId}"]`);

      wrappers.forEach(w => {
        w.innerHTML = newHtml;
      });
    }

    function setupCartListeners() {
      document.addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn) return;

        if (btn.classList.contains('add-to-cart-btn')) {
          const product = {
            id: btn.dataset.id,
            name: btn.dataset.name,
            category: btn.dataset.category,
            type: btn.dataset.type,
            image: btn.dataset.image,
            price: parseFloat(btn.dataset.price || 0),
            currency: btn.dataset.currency || 'INR',
            quantity: 1
          };
          let cart = getCart();
          if (!cart.find(i => i.id === product.id)) {
            cart.push(product);
            saveCart(cart);
            updateProductCartUI(product.id);
          }
        } else if (btn.classList.contains('qty-plus')) {
          const id = btn.dataset.id;
          let cart = getCart();
          const item = cart.find(i => i.id === id);
          if (item) {
            item.quantity = (item.quantity || 1) + 1;
            saveCart(cart);
            updateProductCartUI(id);
          }
        } else if (btn.classList.contains('qty-minus')) {
          const id = btn.dataset.id;
          let cart = getCart();
          const item = cart.find(i => i.id === id);
          if (item) {
            item.quantity = (item.quantity || 1) - 1;
            if (item.quantity <= 0) {
              cart = cart.filter(i => i.id !== id);
            }
            saveCart(cart);
            updateProductCartUI(id);
          }
        }
      });

      document.addEventListener('change', e => {
        if (e.target.classList.contains('qty-input')) {
          const id = e.target.dataset.id;
          let val = parseInt(e.target.value);
          if (isNaN(val) || val < 1) val = 1;

          let cart = getCart();
          const item = cart.find(i => i.id === id);
          if (item) {
            item.quantity = val;
            saveCart(cart);
            updateProductCartUI(id);
          }
        }
      });
    }

    function updateCartBadge() {
      const badge = document.getElementById("cartCountBadge");
      if (!badge) return; // Badge element may not exist

      const list = JSON.parse(localStorage.getItem("inquiryList") || "[]");
      const count = list.length;

      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }

    (async () => {
      const data = await fetchSaleor();
      if (!data) return alert("Error fetching Saleor API");

      allCategories = data.categories?.edges?.map(e => e.node) || [];
      let products = data.products?.edges?.map(e => e.node) || [];

      // Find the hidden category and all its subcategories
      const hiddenCategory = allCategories.find(c => c.name === HIDDEN_CATEGORY_NAME);
      const hiddenCategoryId = hiddenCategory?.id;
      const hiddenSubcategoryIds = hiddenCategoryId
        ? allCategories.filter(c => c.parent?.id === hiddenCategoryId).map(c => c.id)
        : [];

      // Filter out products from hidden category and its subcategories
      allProducts = products.filter(p => {
        const categoryId = p.category?.id;
        const parentCategoryId = p.category?.parent?.id;

        // Exclude if product is directly in hidden category
        if (categoryId === hiddenCategoryId) return false;
        // Exclude if product is in a subcategory of hidden category
        if (hiddenSubcategoryIds.includes(categoryId)) return false;
        // Exclude if product's parent category is the hidden category
        if (parentCategoryId === hiddenCategoryId) return false;

        return true;
      });

      renderCategoryFilters(allCategories, allProducts);

      // Check URL for search query
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('q');
      if (query) {
        document.getElementById("searchInput").value = query;
      }

      applyFilters();

      setupFiltering();
      setupCartListeners();
      updateCartBadge();
      document.getElementById("loadingSpinner").classList.add("hidden");
    })();
  </script>

  <script src="placeholder.js"></script>
</body>

</html>